
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MonBailZen ‚Äì Gestion Locative & Baux</title>
<style>
/* ---------- Th√®me Gold & Dark ---------- */
:root{
  --bg:#0a0b0f;
  --bg2:#0f1117;
  --card:#11141b;
  --muted:#c7c9d1;
  --text:#f4f5f7;
  --accent:#d4af37;
  --accent-weak:rgba(212,175,55,.16);
  --ring:0 0 0 3px rgba(212,175,55,.35);
  --shadow:0 8px 25px rgba(0,0,0,.45);
  --radius:14px;
}
body{
  margin:0;font-family:"Inter",sans-serif;background:var(--bg);
  color:var(--text);line-height:1.5;
}
header{
  background:linear-gradient(90deg,#0a0b0f,#14161c);
  border-bottom:1px solid #22242b;
  padding:10px 14px;display:flex;justify-content:space-between;align-items:center;
}
header h1{color:var(--accent);font-size:1.4rem;margin:0}
nav{display:flex;gap:8px;flex-wrap:wrap}
.tabbtn{
  background:none;border:1px solid #2a2c33;color:var(--text);
  border-radius:8px;padding:6px 10px;cursor:pointer;
}
.tabbtn.active,.tabbtn:hover{
  background:var(--accent-weak);color:var(--accent);border-color:var(--accent);
}
main{padding:14px}
.card{
  background:linear-gradient(180deg,var(--card),#0e1219);
  border:1px solid #232937;border-radius:var(--radius);
  box-shadow:var(--shadow);padding:14px;margin-bottom:14px;
}
h2{color:var(--accent);margin-top:0}
label{display:block;font-size:.9rem;margin-bottom:3px;color:var(--muted)}
input,select,textarea{
  width:100%;padding:6px 8px;border-radius:6px;border:1px solid #30343e;
  background:#0d1016;color:#eee;box-sizing:border-box;
}
input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring);border-color:var(--accent)}
.btn{
  background:#1a1c23;border:1px solid #343744;color:var(--text);
  border-radius:8px;padding:6px 12px;cursor:pointer;
}
.btn:hover{background:#22252c}
.btn.accent{background:var(--accent);color:#1d1604;border-color:transparent}
.btn.accent:hover{background:#e0be52}
.note{font-size:.85rem;color:#aaa;margin-top:4px}
.table{
  width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;
  background:#0d1117;border:1px solid #262c3a;border-radius:12px;overflow:hidden;
}
.table th{
  background:linear-gradient(180deg,#141926,#101521);
  color:#f6f6f6;text-align:left;padding:10px 12px;position:sticky;top:0;
}
.table td{padding:10px 12px;border-top:1px solid #1f2532}
.table tbody tr:nth-child(even){background:#0f1420}
.table tfoot td{font-weight:800;border-top:2px solid #31394b}
.badge-total{
  display:inline-block;padding:4px 8px;border-radius:999px;
  background:var(--accent-weak);border:1px solid rgba(212,175,55,.4);color:#e9d79a;
}
.row{display:flex;flex-wrap:wrap;gap:10px}
.col-2{flex:0 0 calc(16.66% - 10px)}.col-3{flex:0 0 calc(25% - 10px)}.col-4{flex:0 0 calc(33.33% - 10px)}
.col-5{flex:0 0 calc(41.66% - 10px)}.col-6{flex:0 0 calc(50% - 10px)}.col-12{flex:0 0 100%}
.hidden{display:none!important}
</style>
</head>
<body>
<header>
  <h1>MonBailZen</h1>
  <nav>
    <button class="tabbtn active" data-tab="home">Accueil</button>
    <button class="tabbtn" data-tab="baux">Baux</button>
    <button class="tabbtn" data-tab="edl">EDL</button>
    <button class="tabbtn" data-tab="biens">Biens & Renta</button>
    <button class="tabbtn" data-tab="sign">Signatures</button>
  </nav>
</header>
<main>
<section id="home" class="card">
  <h2>Bienvenue sur MonBailZen</h2>
  <p>Cr√©ez vos baux, √©tats des lieux, suivez vos logements et calculez vos rentabilit√©s. Tout fonctionne en local, sans serveur, et adopte votre th√®me sombre & dor√© pr√©f√©r√© ‚ú®.</p>
  <h3>üí∞ Tarifs officiels</h3>
  <table class="table">
    <thead><tr><th>Offre</th><th>Mensuel</th><th>Annuel</th><th>Inclus</th></tr></thead>
    <tbody>
      <tr><td>Essai 7 j</td><td>0 ‚Ç¨</td><td>‚Äî</td><td>1 bail + 1 EDL entr√©e</td></tr>
      <tr><td>Unitaire</td><td>7,90 ‚Ç¨</td><td>‚Äî</td><td>1 bail + 1 EDL entr√©e + cr√©dit sortie 0,5</td></tr>
      <tr><td>Starter</td><td>24 ‚Ç¨/mois</td><td>240 ‚Ç¨/an</td><td>3 baux + 3 EDL + IRL auto + export PDF/Word</td></tr>
      <tr><td>Pro</td><td>59 ‚Ç¨/mois</td><td>590 ‚Ç¨/an</td><td>Illimit√© + logo perso + export compta / Excel</td></tr>
      <tr><td>Pause & sauvegarde</td><td>2 ‚Ç¨/mois</td><td>20 ‚Ç¨/an</td><td>Lecture seule + sauvegarde + r√©activation simple</td></tr>
    </tbody>
  </table>
  <!-- ===== SECTION BAUX ===== -->
<section id="baux" class="card hidden">
  <h2>üìë Cr√©ation de bail</h2>

  <div class="row">
    <div class="col-4">
      <label>Type de bail</label>
      <select id="b_type">
        <option>Location vide</option>
        <option>Meubl√©e</option>
        <option>Saisonnier</option>
        <option>Mobilit√©</option>
      </select>
    </div>
    <div class="col-4">
      <label>Dur√©e (mois)</label>
      <input id="b_duree" type="number" value="36">
    </div>
    <div class="col-4">
      <label>Pr√©avis locataire (mois)</label>
      <input id="b_preavis" type="number" value="3">
    </div>

    <div class="col-6">
      <label>Bailleur</label>
      <input id="b_bailleur" placeholder="Nom, pr√©nom, adresse‚Ä¶">
    </div>
    <div class="col-6">
      <label>Locataire</label>
      <input id="b_locataire" placeholder="Nom, pr√©nom, adresse‚Ä¶">
    </div>

    <div class="col-4">
      <label>Loyer HC (‚Ç¨)</label>
      <input id="b_loyer" type="number">
    </div>
    <div class="col-4">
      <label>Charges (‚Ç¨)</label>
      <input id="b_charge" type="number">
    </div>
    <div class="col-4">
      <label>Date de d√©but</label>
      <input id="b_date_debut" type="date">
    </div>

    <div class="col-6">
      <label>Garants (nom, adresse‚Ä¶)</label>
      <input id="b_garant" placeholder="Laisser vide si aucun">
    </div>
    <div class="col-6">
      <label>Clause solidaire (auto)</label>
      <textarea id="b_clause" rows="3" readonly></textarea>
    </div>
  </div>

  <div class="card" id="b_annexes">
    <h3>üìé Annexes et remarques</h3>
    <textarea id="b_annexe_txt" rows="5" placeholder="Ajoutez ici des annexes ou mentions particuli√®res (travaux, √©quipements, etc.)"></textarea>
  </div>

  <div class="row">
    <div class="col-6 card">
      <h3>üìà Indexation IRL automatique</h3>
      <label>Trimestre de r√©f√©rence</label>
      <select id="b_irl_trim">
        <option>T1</option><option>T2</option><option>T3</option><option>T4</option>
      </select>
      <label>Ann√©e de r√©f√©rence</label>
      <input id="b_irl_year" type="number" value="2025">
      <label>Date d‚Äôanniversaire du bail</label>
      <input id="b_irl_date" type="date">
      <div class="note">L‚Äôindexation IRL est calcul√©e automatiquement selon le trimestre choisi.</div>
      <button class="btn accent" id="b_calc_irl">üì© G√©n√©rer courrier IRL</button>
      <div id="b_irl_result" class="note"></div>
    </div>

    <div class="col-6 card">
      <h3>üè† Assurance habitation</h3>
      <label>Date de pr√©sentation de l‚Äôattestation</label>
      <input id="b_assu_date" type="date">
      <label>Statut</label>
      <select id="b_assu_statut">
        <option>En attente</option><option>Re√ßue</option><option>Relance √† faire</option>
      </select>
      <button class="btn accent" id="b_assu_courrier">üì© G√©n√©rer courrier assurance</button>
      <div id="b_assu_note" class="note"></div>
    </div>
  </div>

  <div style="margin-top:12px">
    <button class="btn accent" id="b_save">üíæ Enregistrer le bail</button>
    <button class="btn" id="b_preview">üëÅÔ∏è Aper√ßu bail</button>
  </div>

  <div id="b_preview_zone" class="card hidden">
    <h3>üñ®Ô∏è Aper√ßu du bail</h3>
    <div id="bail_print"></div>
  </div>
</section>

<script>
// ==== LOGIQUE BAUX ====
const BAIL_RULES={
  "Location vide":{duree_mois:36,preavis_mois:3},
  "Meubl√©e":{duree_mois:12,preavis_mois:1},
  "Saisonnier":{duree_mois:3,preavis_mois:0},
  "Mobilit√©":{duree_mois:6,preavis_mois:1}
};
function applyBailRules(){
  const t=b_type.value, r=BAIL_RULES[t]; if(!r)return;
  if(t==="Saisonnier"||t==="Mobilit√©"){
    if(!b_duree.value)b_duree.value=r.duree_mois;
  } else { b_duree.value=r.duree_mois; }
  b_preavis.value=r.preavis_mois;
  b_clause.value = b_garant.value.trim() ?
    `Le garant, ${b_garant.value}, s‚Äôengage solidairement avec le locataire pour la dur√©e du bail de ${b_duree.value} mois, renouvelable selon la loi applicable au bail ${t.toLowerCase()}.` :
    "Aucun garant d√©clar√©.";
}
b_type.onchange=applyBailRules; b_garant.oninput=applyBailRules;

// === IRL automatique ===
async function fetchIRL(trim,year){
  const ref={T1:138.61,T2:140.59,T3:142.69,T4:144.25}; // base provisoire
  return ref[trim]||140;
}
b_calc_irl.onclick=async()=>{
  const trim=b_irl_trim.value,year=+b_irl_year.value;
  const ref=await fetchIRL(trim,year-1), newv=await fetchIRL(trim,year);
  const pct=((newv-ref)/ref)*100;
  const nvLoyer=(+b_loyer.value)*(1+pct/100);
  b_irl_result.innerHTML=`IRL ${trim} ${year} : ${ref} ‚Üí ${newv} soit +${pct.toFixed(2)}%.<br>Nouveau loyer HC : <strong>${nvLoyer.toFixed(2)} ‚Ç¨</strong>`;
};

// === Courrier IRL / Assurance ===
b_assu_courrier.onclick=()=>{
  const date=b_assu_date.value||"____";
  const msg=`<h4>Courrier de relance assurance habitation</h4>
  <p>Conform√©ment au bail, nous vous rappelons de transmettre une attestation d‚Äôassurance habitation √† jour. Date limite : ${date}.</p>`;
  b_assu_note.innerHTML=msg;
};

// === Sauvegarde locale simple ===
function bailData(){
  return {
    type:b_type.value,duree:b_duree.value,preavis:b_preavis.value,bailleur:b_bailleur.value,locataire:b_locataire.value,
    loyer:b_loyer.value,charge:b_charge.value,date:b_date_debut.value,garant:b_garant.value,annexe:b_annexe_txt.value
  };
}
b_save.onclick=()=>{ localStorage.setItem("mbz.bail",JSON.stringify(bailData())); alert("Bail enregistr√© localement."); };

// === Aper√ßu (simplifi√©, insertion signature faite plus tard) ===
b_preview.onclick=()=>{
  const d=JSON.parse(localStorage.getItem("mbz.bail")||"{}");
  const html=`
    <h4>Bail ${d.type||""}</h4>
    <p><strong>Bailleur :</strong> ${d.bailleur||""}<br>
    <strong>Locataire :</strong> ${d.locataire||""}<br>
    <strong>Loyer HC :</strong> ${d.loyer||""} ‚Ç¨ + charges ${d.charge||""} ‚Ç¨</p>
    <p><strong>Dur√©e :</strong> ${d.duree||""} mois, pr√©avis ${d.preavis||""} mois</p>
    <p><strong>Garant :</strong> ${d.garant||"Aucun"}</p>
    <p><em>Clause solidaire :</em> ${b_clause.value}</p>
    <p><strong>Annexes :</strong><br>${d.annexe||"‚Äî"}</p>`;
  b_preview_zone.classList.remove("hidden");
  bail_print.innerHTML=html;
};
</script>
<!-- ===== SECTION EDL (√âtats des lieux) ===== -->
<section id="edl" class="card hidden">
  <h2>üõ†Ô∏è EDL avanc√© ‚Äî pi√®ces, √©l√©ments, photos, relev√©s & inventaire</h2>

  <!-- En-t√™te EDL -->
  <div class="row">
    <div class="col-6">
      <label>Bien (adresse)</label>
      <input id="e_bien" placeholder="Ex: 4 rue Quiquerue, Ault">
    </div>

    <div class="col-3">
      <label>Ajouter une pi√®ce (liste)</label>
      <select id="e_piece_select"></select>
    </div>
    <div class="col-3" style="display:flex;align-items:end">
      <button class="btn accent" id="e_add_piece">Ajouter la pi√®ce</button>
    </div>

    <div class="col-6">
      <label>Nouvelle pi√®ce personnalis√©e</label>
      <input id="e_piece_custom" placeholder="Ex: Chambre 2, Cellier, Terrasse‚Ä¶">
    </div>
    <div class="col-6" style="display:flex;align-items:end">
      <button class="btn" id="e_add_piece_custom">Ajouter pi√®ce personnalis√©e</button>
    </div>
  </div>

  <!-- Liste de pi√®ces -->
  <div id="e_pieces_container" class="row" style="margin-top:10px"></div>

  <!-- Relev√©s compteurs -->
  <div class="card" style="margin-top:16px">
    <h3>üîå Relev√©s compteurs</h3>
    <div class="row">
      <div class="col-3">
        <label>Type</label>
        <select id="m_type"><option>Eau</option><option>√âlectricit√©</option><option>Gaz</option></select>
      </div>
      <div class="col-3">
        <label>N¬∞ compteur</label>
        <input id="m_numero" placeholder="N¬∞">
      </div>
      <div class="col-3">
        <label>Valeur relev√©e</label>
        <input id="m_valeur" type="number" step="0.01" placeholder="ex: 12345.6">
      </div>
      <div class="col-3">
        <label>Date du relev√©</label>
        <input id="m_date" type="date">
      </div>
      <div class="col-6">
        <label>Photo du compteur</label>
        <input id="m_photo" type="file" accept="image/*" capture="environment">
      </div>
      <div class="col-6" style="display:flex;align-items:end">
        <button class="btn" id="m_add">Ajouter le relev√©</button>
      </div>
    </div>
    <div id="m_list" class="row" style="margin-top:10px"></div>
  </div>

  <!-- Inventaire mobilier -->
  <div class="card" style="margin-top:16px">
    <h3>üßæ Inventaire (meubl√© / mobilit√© / saisonnier / colocation)</h3>
    <p class="note">Affich√© si le type de bail est Meubl√©e, Mobilit√©, Saisonnier ou Colocation.</p>
    <div class="row">
      <div class="col-4">
        <label>Ajouter un item (liste)</label>
        <select id="inv_select"></select>
      </div>
      <div class="col-2">
        <label>Quantit√©</label>
        <input id="inv_qty" type="number" value="1" min="1">
      </div>
      <div class="col-3">
        <label>√âtat</label>
        <select id="inv_state"></select>
      </div>
      <div class="col-3" style="display:flex;align-items:end">
        <button class="btn" id="inv_add">Ajouter</button>
      </div>

      <div class="col-6">
        <label>Nouvel item personnalis√©</label>
        <input id="inv_custom" placeholder="Ex: Cafeti√®re, Grille-pain‚Ä¶">
      </div>
      <div class="col-6" style="display:flex;align-items:end">
        <button class="btn" id="inv_add_custom">Ajouter item personnalis√©</button>
      </div>
    </div>
    <div id="inv_list" class="row" style="margin-top:10px"></div>
  </div>

  <!-- Exports EDL -->
  <div style="margin-top:16px">
    <button class="btn" id="e_export_csv">Exporter CSV</button>
    <button class="btn" id="e_export_json">Exporter JSON</button>
  </div>
</section>

<!-- ===== SECTION SIGNATURES ===== -->
<section id="sign" class="card hidden">
  <h2>‚úçÔ∏è Signatures (dessin ou import)</h2>
  <p class="note">Enregistrez vos signatures, d√©finissez celles du Bailleur/Locataire par d√©faut et ins√©rez-les automatiquement dans l‚Äôaper√ßu du bail.</p>

  <div class="row">
    <div class="col-12">
      <label>Nom de la signature</label>
      <input id="s_label" placeholder="Ex: Bailleur ‚Äì DUPONT">
    </div>
    <div class="col-12">
      <canvas id="s_canvas" width="720" height="260" style="background:#fff;border-radius:12px;border:1px solid #c7c7c7;touch-action:none"></canvas>
      <div class="note">Maintenez clic / doigt pour dessiner. Effacez si besoin et recommencez.</div>
    </div>
    <div class="col-6">
      <label>Importer une image (PNG/JPG)</label>
      <input type="file" id="s_file" accept="image/*">
    </div>
    <div class="col-6" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
      <button class="btn" id="s_load_img">Placer l‚Äôimage</button>
      <button class="btn" id="s_clear">Effacer</button>
    </div>
    <div class="col-12" style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn accent" id="s_save">Enregistrer</button>
      <button class="btn" id="s_export_png">Exporter PNG</button>
      <button class="btn" id="s_set_default_b">D√©faut Bailleur</button>
      <button class="btn" id="s_set_default_l">D√©faut Locataire</button>
    </div>

    <div class="col-12">
      <h3>Biblioth√®que</h3>
      <div id="s_gallery" class="row" style="gap:12px"></div>
    </div>
  </div>
</section>

<script>
/* ===== EDL ‚Äî Donn√©es par d√©faut & store ===== */
const EDL_DEFAULT_ROOMS=["Entr√©e","Salon / S√©jour","Cuisine","Chambre 1","Chambre 2","Salle de bain","WC","Couloir","Balcon / Terrasse","Cave / Cellier"];
const EDL_DEFAULT_ELEMENTS=["Murs","Plafond","Sol","Plinthes","Portes","Fen√™tres","Volets/Stores","√âlectricit√©","Prises","√âclairage","Chauffage/Radiateurs","EAU/Robinetterie","Sanitaires","√âlectrom√©nager","Rangements/Placards","Divers"];
const EDL_STATES=["Neuf","Tr√®s bon","Bon","Moyen","√Ä r√©nover","HS / Non fonctionnel"];
const INV_DEFAULT_ITEMS=["Lit 140","Lit 160","Table","Chaises x4","Canap√©","Armoire","Bureau","Plaques cuisson","Four","Micro-ondes","R√©frig√©rateur","Lave-linge","Assiettes x6","Verres x6","Couverts x6","Casseroles x3","Po√™le","Ustensiles divers"];

function edlLoad(){return JSON.parse(localStorage.getItem("mbz.edl_v2")||"null")||{bien:"",rooms:[],meters:[],inventory:[]}}
function edlSave(data){localStorage.setItem("mbz.edl_v2",JSON.stringify(data))}
let EDL = edlLoad();

/* Helpers */
const ePieceSel=document.getElementById("e_piece_select");
const invSel=document.getElementById("inv_select");
const invStateSel=document.getElementById("inv_state");
function fillSelectOptions(sel,arr){sel.innerHTML=arr.map(v=>`<option>${v}</option>`).join("")}
fillSelectOptions(ePieceSel,EDL_DEFAULT_ROOMS);
fillSelectOptions(invSel,INV_DEFAULT_ITEMS);
fillSelectOptions(invStateSel,EDL_STATES);

/* Bien */
const eBien=document.getElementById("e_bien");
if(EDL.bien) eBien.value=EDL.bien;
eBien?.addEventListener("input",()=>{EDL.bien=eBien.value;edlSave(EDL)});

/* Pi√®ces & √©l√©ments */
const piecesContainer=document.getElementById("e_pieces_container");
function fileToDataURL(file){return new Promise((resolve,reject)=>{const r=new FileReader();r.onload=e=>resolve(e.target.result);r.onerror=reject;r.readAsDataURL(file)})}

function renderRooms(){
  piecesContainer.innerHTML="";
  EDL.rooms.forEach((room,idx)=>{
    const card=document.createElement("div");
    card.className="card col-12";
    card.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h3 style="margin:0">${room.name}</h3>
        <div style="display:flex;gap:8px">
          <button class="btn" data-room-add-el="${idx}">+ √âl√©ment</button>
          <button class="btn" data-room-photo="${idx}">+ Photos pi√®ce</button>
          <button class="btn" data-room-del="${idx}" title="Supprimer">üóë</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px" id="room_photos_${idx}">
        ${room.roomPhotos?.length? room.roomPhotos.map(src=>`
          <div class="col-3"><img src="${src}" style="width:100%;height:150px;object-fit:cover;border-radius:8px;border:1px solid #232937"/></div>
        `).join(""):`<div class="col-12 note">Aucune photo de la pi√®ce.</div>`}
      </div>

      <table class="table" style="margin-top:10px">
        <thead><tr><th>√âl√©ment</th><th>√âtat</th><th>Anomalie</th><th>Photos anomalie</th><th></th></tr></thead>
        <tbody id="room_tbl_${idx}">
          ${room.elements.map((el,i)=>`
            <tr>
              <td><input value="${el.name}" data-el-name="${idx}:${i}"></td>
              <td>
                <select data-el-state="${idx}:${i}">
                  ${EDL_STATES.map(s=>`<option ${s===el.state?'selected':''}>${s}</option>`).join("")}
                </select>
              </td>
              <td><input placeholder="Ex: rayures, fuite, prise HS‚Ä¶" value="${el.anomalies?.[0]?.desc||''}" data-el-anom-desc="${idx}:${i}"></td>
              <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap" id="anom_ph_${idx}_${i}">
                  ${(el.anomalies?.[0]?.photos||[]).map(src=>`<img src="${src}" style="width:72px;height:72px;object-fit:cover;border-radius:6px;border:1px solid #232937">`).join("")}
                </div>
                <input type="file" accept="image/*" capture="environment" data-el-anom-photo="${idx}:${i}" multiple>
              </td>
              <td><button class="btn" data-el-del="${idx}:${i}">‚Äì</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    piecesContainer.appendChild(card);
  });
}

function addRoom(name){
  if(!name||!name.trim()) return;
  EDL.rooms.push({
    name:name.trim(),
    elements:EDL_DEFAULT_ELEMENTS.map(n=>({name:n,state:"Bon",photos:[],anomalies:[{desc:"",photos:[]}]})),
    roomPhotos:[]
  });
  edlSave(EDL); renderRooms();
}

document.getElementById("e_add_piece").addEventListener("click",()=> addRoom(ePieceSel.value));
document.getElementById("e_add_piece_custom").addEventListener("click",()=>{
  const v=document.getElementById("e_piece_custom").value;
  addRoom(v); if(v) document.getElementById("e_piece_custom").value="";
});

piecesContainer.addEventListener("click",async(e)=>{
  const t=e.target;
  if(t.dataset.roomDel){
    const idx=parseInt(t.dataset.roomDel,10);
    if(confirm("Supprimer cette pi√®ce ?")){
      EDL.rooms.splice(idx,1); edlSave(EDL); renderRooms();
    }
    return;
  }
  if(t.dataset.roomAddEl){
    const idx=parseInt(t.dataset.roomAddEl,10);
    const name=prompt("Nom de l'√©l√©ment ?");
    if(name){
      EDL.rooms[idx].elements.push({name,state:"Bon",photos:[],anomalies:[{desc:"",photos:[]}]} );
      edlSave(EDL); renderRooms();
    }
    return;
  }
  if(t.dataset.roomPhoto){
    const idx=parseInt(t.dataset.roomPhoto,10);
    const inp=document.createElement("input");
    inp.type="file"; inp.accept="image/*"; inp.multiple=true; inp.capture="environment";
    inp.onchange=async()=>{
      const files=[...inp.files];
      for(const f of files){ const data=await fileToDataURL(f); EDL.rooms[idx].roomPhotos.push(data); }
      edlSave(EDL); renderRooms();
    };
    inp.click();
    return;
  }
});

piecesContainer.addEventListener("input",async(e)=>{
  const t=e.target;
  if(t.dataset.elName){ const [ri,ei]=t.dataset.elName.split(":").map(Number); EDL.rooms[ri].elements[ei].name=t.value; edlSave(EDL); }
  if(t.dataset.elState){ const [ri,ei]=t.dataset.elState.split(":").map(Number); EDL.rooms[ri].elements[ei].state=t.value; edlSave(EDL); }
  if(t.dataset.elAnomDesc){ const [ri,ei]=t.dataset.elAnomDesc.split(":").map(Number); EDL.rooms[ri].elements[ei].anomalies[0].desc=t.value; edlSave(EDL); }
  if(t.dataset.elAnomPhoto){
    const [ri,ei]=t.dataset.elAnomPhoto.split(":").map(Number);
    const files=[...t.files];
    for(const f of files){ const data=await fileToDataURL(f); EDL.rooms[ri].elements[ei].anomalies[0].photos.push(data); }
    edlSave(EDL); renderRooms();
  }
});
piecesContainer.addEventListener("click",(e)=>{
  const t=e.target;
  if(t.dataset.elDel){
    const [ri,ei]=t.dataset.elDel.split(":").map(Number);
    EDL.rooms[ri].elements.splice(ei,1); edlSave(EDL); renderRooms();
  }
});

/* Relev√©s compteurs */
const mList=document.getElementById("m_list");
function renderMeters(){
  mList.innerHTML = (EDL.meters||[]).map((m,i)=>`
    <div class="card col-4">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${m.type}</strong>
        <button class="btn" data-m-del="${i}">üóë</button>
      </div>
      <div class="note">N¬∞ ${m.numero} ‚Äî Valeur ${m.valeur} ‚Äî Date ${m.date||"‚Äî"}</div>
      ${m.photo? `<img src="${m.photo}" style="width:100%;max-height:180px;object-fit:contain;border:1px solid #232937;border-radius:8px;margin-top:6px;background:#fff">` : ""}
    </div>
  `).join("");
}
document.getElementById("m_add").addEventListener("click",async()=>{
  const type=m_type.value, numero=m_numero.value, valeur=m_valeur.value, date=m_date.value;
  const file=m_photo.files[0]; let photo=""; if(file) photo=await fileToDataURL(file);
  EDL.meters.push({type,numero,valeur,date,photo}); edlSave(EDL); renderMeters();
  ["m_numero","m_valeur","m_date","m_photo"].forEach(id=>{const el=document.getElementById(id); if(el) el.value="";});
});
mList.addEventListener("click",(e)=>{
  const t=e.target; if(t.dataset.mDel){ const i=+t.dataset.mDel; EDL.meters.splice(i,1); edlSave(EDL); renderMeters(); }
});

/* Inventaire */
const invList=document.getElementById("inv_list");
function renderInventory(){
  invList.innerHTML = (EDL.inventory||[]).map((it,i)=>`
    <div class="card col-6">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <strong>${it.name}</strong>
        <div style="display:flex;gap:8px">
          <span class="badge-total">Qt√© ${it.qty}</span>
          <span class="badge-total">${it.state}</span>
          <button class="btn" data-inv-photo="${i}">+ Photo</button>
          <button class="btn" data-inv-del="${i}">üóë</button>
        </div>
      </div>
      ${it.photos?.length? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${it.photos.map(p=>`<img src="${p}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #232937">`).join("")}</div>`:""}
    </div>
  `).join("");
}
function invAdd(name,qty,state){ if(!name) return; EDL.inventory.push({name,qty:+qty||1,state:state||"Bon",photos:[]}); edlSave(EDL); renderInventory(); }
document.getElementById("inv_add").addEventListener("click",()=> invAdd(invSel.value, inv_qty.value, invStateSel.value));
document.getElementById("inv_add_custom").addEventListener("click",()=>{
  const name=inv_custom.value; invAdd(name,inv_qty.value,invStateSel.value); if(name) inv_custom.value="";
});
invList.addEventListener("click",(e)=>{
  const t=e.target;
  if(t.dataset.invDel){ const i=+t.dataset.invDel; EDL.inventory.splice(i,1); edlSave(EDL); renderInventory(); return; }
  if(t.dataset.invPhoto){
    const i=+t.dataset.invPhoto;
    const inp=document.createElement("input");
    inp.type="file"; inp.accept="image/*"; inp.capture="environment";
    inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; const data=await fileToDataURL(f); EDL.inventory[i].photos=EDL.inventory[i].photos||[]; EDL.inventory[i].photos.push(data); edlSave(EDL); renderInventory(); };
    inp.click();
  }
});

/* Visibilit√© inventaire selon type de bail */
function updateInventoryVisibility(){
  const type=(document.getElementById("b_type")||{}).value||"Location vide";
  const card=invList.closest(".card"); if(!card) return;
  const show=["Meubl√©e","Mobilit√©","Saisonnier","Colocation"].includes(type);
  card.style.display = show ? "block" : "none";
}
document.getElementById("b_type")?.addEventListener("change",updateInventoryVisibility);

/* Exports EDL */
function edlToCSV(){
  let csv="section;champ;valeur\n";
  csv += `bien;adresse;${EDL.bien||""}\n`;
  (EDL.rooms||[]).forEach((r,ri)=>{
    csv += `piece_${ri+1};nom;${r.name}\n`;
    csv += `piece_${ri+1};photos_piece;${(r.roomPhotos||[]).length}\n`;
    (r.elements||[]).forEach((el,ei)=>{
      csv += `piece_${ri+1}_el_${ei+1};element;${el.name}\n`;
      csv += `piece_${ri+1}_el_${ei+1};etat;${el.state}\n`;
      const an = el.anomalies?.[0] || {desc:"",photos:[]};
      csv += `piece_${ri+1}_el_${ei+1};anomalie;${an.desc||""}\n`;
      csv += `piece_${ri+1}_el_${ei+1};photos_anomalie;${(an.photos||[]).length}\n`;
    });
  });
  (EDL.meters||[]).forEach((m,mi)=>{
    csv += `compteur_${mi+1};type;${m.type}\n`;
    csv += `compteur_${mi+1};numero;${m.numero}\n`;
    csv += `compteur_${mi+1};valeur;${m.valeur}\n`;
    csv += `compteur_${mi+1};date;${m.date}\n`;
  });
  (EDL.inventory||[]).forEach((it,ii)=>{
    csv += `inventaire_${ii+1};item;${it.name}\n`;
    csv += `inventaire_${ii+1};quantite;${it.qty}\n`;
    csv += `inventaire_${ii+1};etat;${it.state}\n`;
    csv += `inventaire_${ii+1};photos;${(it.photos||[]).length}\n`;
  });
  return csv;
}
document.getElementById("e_export_csv").addEventListener("click",()=>{
  const blob=new Blob([edlToCSV()],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download="edl_avance.csv"; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById("e_export_json").addEventListener("click",()=>{
  const s=JSON.stringify(EDL,null,2);
  const blob=new Blob([s],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download="edl_avance.json"; a.click(); URL.revokeObjectURL(a.href);
});

/* Rendu initial */
renderRooms(); renderMeters(); renderInventory(); updateInventoryVisibility();

/* ===== Signatures ‚Äî dessin / import / d√©fauts ===== */
const sCanvas=document.getElementById("s_canvas");
const sCtx=sCanvas.getContext("2d");
function clearCanvas(){ sCtx.fillStyle="#fff"; sCtx.fillRect(0,0,sCanvas.width,sCanvas.height); }
clearCanvas();
// dessin souris/tactile
let drawing=false,lastX=0,lastY=0;
function posFromEvent(e){const r=sCanvas.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;return{x,y}}
function startDraw(e){drawing=true;const p=posFromEvent(e);lastX=p.x;lastY=p.y}
function stopDraw(){drawing=false}
function draw(e){if(!drawing)return;e.preventDefault();const p=posFromEvent(e);sCtx.lineWidth=2.6;sCtx.lineJoin="round";sCtx.lineCap="round";sCtx.strokeStyle="#000";sCtx.beginPath();sCtx.moveTo(lastX,lastY);sCtx.lineTo(p.x,p.y);sCtx.stroke();lastX=p.x;lastY=p.y}
sCanvas.addEventListener("mousedown",startDraw); sCanvas.addEventListener("mousemove",draw); window.addEventListener("mouseup",stopDraw);
sCanvas.addEventListener("touchstart",startDraw,{passive:false}); sCanvas.addEventListener("touchmove",draw,{passive:false}); sCanvas.addEventListener("touchend",stopDraw);

// Fichier > canvas
document.getElementById("s_load_img").addEventListener("click",()=>{
  const f=document.getElementById("s_file").files[0];
  if(!f){ alert("Choisissez une image de signature."); return; }
  const r=new FileReader();
  r.onload=e=>{ const img=new Image(); img.onload=()=>{ clearCanvas(); const s=Math.min(sCanvas.width/img.width,sCanvas.height/img.height); const w=img.width*s,h=img.height*s,x=(sCanvas.width-w)/2,y=(sCanvas.height-h)/2; sCtx.drawImage(img,x,y,w,h) }; img.src=e.target.result; };
  r.readAsDataURL(f);
});
document.getElementById("s_clear").addEventListener("click",clearCanvas);
document.getElementById("s_export_png").addEventListener("click",()=>{
  const a=document.createElement("a"); a.href=sCanvas.toDataURL("image/png"); a.download=(s_label.value||"signature")+".png"; a.click();
});

// Store signatures
function loadSignStore(){return JSON.parse(localStorage.getItem("mbz.signatures")||"[]")}
function saveSignStore(arr){localStorage.setItem("mbz.signatures",JSON.stringify(arr))}
function loadSignDefaults(){return JSON.parse(localStorage.getItem("mbz.sig.defaults")||"{}")}
function saveSignDefaults(o){localStorage.setItem("mbz.sig.defaults",JSON.stringify(o))}

// enregistrer
document.getElementById("s_save").addEventListener("click",()=>{
  const label=(s_label.value||"Signature").trim();
  const data=sCanvas.toDataURL("image/png");
  const list=loadSignStore(); list.unshift({label,data,ts:Date.now()}); saveSignStore(list);
  refreshGallery(); alert("Signature enregistr√©e.");
});
// d√©fauts
document.getElementById("s_set_default_b").addEventListener("click",()=>{
  const defs=loadSignDefaults(); defs.bailleur=sCanvas.toDataURL("image/png"); saveSignDefaults(defs);
  renderSignaturesInPreview(); alert("D√©finie comme signature par d√©faut du Bailleur.");
});
document.getElementById("s_set_default_l").addEventListener("click",()=>{
  const defs=loadSignDefaults(); defs.locataire=sCanvas.toDataURL("image/png"); saveSignDefaults(defs);
  renderSignaturesInPreview(); alert("D√©finie comme signature par d√©faut du Locataire.");
});

// galerie
function refreshGallery(){
  const wrap=document.getElementById("s_gallery"); if(!wrap) return;
  const list=loadSignStore();
  wrap.innerHTML="";
  list.forEach((it,idx)=>{
    const c=document.createElement("div");
    c.className="card col-3";
    c.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${it.label||"Signature"}</strong>
        <button class="btn" data-del="${idx}" title="Supprimer">üóë</button>
      </div>
      <div style="display:grid;place-items:center;margin-top:8px">
        <img src="${it.data}" style="max-width:100%;max-height:120px;object-fit:contain;border:1px solid #232937;border-radius:8px;background:#fff">
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px">
        <button class="btn" data-load="${idx}">Charger</button>
        <button class="btn" data-defb="${idx}">D√©faut Bailleur</button>
        <button class="btn" data-defl="${idx}">D√©faut Locataire</button>
      </div>
    `;
    wrap.appendChild(c);
  });
}
document.getElementById("s_gallery").addEventListener("click",(e)=>{
  const t=e.target; const list=loadSignStore();
  if(t.dataset.load){
    const it=list[+t.dataset.load]; if(!it) return;
    const img=new Image(); img.onload=()=>{ clearCanvas(); const s=Math.min(sCanvas.width/img.width,sCanvas.height/img.height); const w=img.width*s,h=img.height*s,x=(sCanvas.width-w)/2,y=(sCanvas.height-h)/2; sCtx.drawImage(img,x,y,w,h); s_label.value=it.label||""; }; img.src=it.data;
  }
  if(t.dataset.del){
    const i=+t.dataset.del; if(confirm("Supprimer cette signature ?")){ list.splice(i,1); saveSignStore(list); refreshGallery(); }
  }
  if(t.dataset.defb||t.dataset.defl){
    const i=+ (t.dataset.defb||t.dataset.defl); const it=list[i]; if(!it) return;
    const defs=loadSignDefaults();
    if(t.dataset.defb){ defs.bailleur=it.data; alert("D√©finie comme d√©faut Bailleur."); }
    if(t.dataset.defl){ defs.locataire=it.data; alert("D√©finie comme d√©faut Locataire."); }
    saveSignDefaults(defs); renderSignaturesInPreview();
  }
});
refreshGallery();

/* Insertion auto des signatures dans l'aper√ßu du bail */
function renderSignaturesInPreview(){
  const defs=loadSignDefaults();
  const zone=document.getElementById("bail_print"); if(!zone) return;
  // si les conteneurs n'existent pas encore ‚Üí les cr√©er
  let signBlock=zone.querySelector(".sign-block");
  if(!signBlock){
    signBlock=document.createElement("div");
    signBlock.className="sign-block";
    signBlock.innerHTML=`
      <hr style="border:none;border-top:1px solid #ddd;margin:14px 0">
      <div style="display:flex;gap:40px;align-items:center">
        <div style="text-align:center"><div>Signature Bailleur</div><img id="sig_b_img" style="max-width:260px;max-height:110px;object-fit:contain"></div>
        <div style="text-align:center"><div>Signature Locataire</div><img id="sig_l_img" style="max-width:260px;max-height:110px;object-fit:contain"></div>
      </div>`;
    zone.appendChild(signBlock);
  }
  const sb=zone.querySelector("#sig_b_img"), sl=zone.querySelector("#sig_l_img");
  if(sb) sb.src = defs?.bailleur || "";
  if(sl) sl.src = defs?.locataire || "";
}
// appeler apr√®s chaque aper√ßu bail
(function hookPreview(){
  const btn=document.getElementById("b_preview");
  if(!btn) return;
  const old=btn.onclick;
  btn.onclick=(ev)=>{
    if(typeof old==="function") old(ev);
    setTimeout(renderSignaturesInPreview, 20);
  };
})();

// Fin EDL & Signatures
</script>
<!-- ===== SECTION BIENS & RENTABILIT√â ===== -->
<section id="biens" class="card hidden">
  <h2>üè† Biens & Rentabilit√©</h2>
  <p class="note">Saisis tes logements (type, adresse, loyer HC, charges, TF‚Ä¶) et suis ta rentabilit√©. Exports CSV/JSON & graphiques int√©gr√©s.</p>

  <!-- Formulaire d'ajout / √©dition -->
  <div class="row">
    <div class="col-3">
      <label>Type de location</label>
      <select id="p_type">
        <option>Location vide</option>
        <option>Meubl√©e</option>
        <option>Saisonnier</option>
        <option>Mobilit√©</option>
        <option>Colocation</option>
      </select>
    </div>
    <div class="col-5">
      <label>Adresse</label>
      <input id="p_adresse" placeholder="N¬∞ rue, ville">
    </div>
    <div class="col-2">
      <label>Loyer HC (‚Ç¨/mois)</label>
      <input id="p_loyer" type="number" step="0.01" value="650">
    </div>
    <div class="col-2">
      <label>Charges (‚Ç¨/mois)</label>
      <input id="p_charges" type="number" step="0.01" value="40">
    </div>

    <div class="col-2">
      <label>TF (‚Ç¨/an)</label>
      <input id="p_tf" type="number" step="0.01" value="800">
    </div>
    <div class="col-2">
      <label>Assurance (‚Ç¨/an)</label>
      <input id="p_assu" type="number" step="0.01" value="120">
    </div>
    <div class="col-2">
      <label>Autres (‚Ç¨/an)</label>
      <input id="p_autres" type="number" step="0.01" value="0">
    </div>
    <div class="col-2">
      <label>Vacance (mois/an)</label>
      <input id="p_vac" type="number" step="0.1" value="1">
    </div>
    <div class="col-2">
      <label>Prix d‚Äôachat (‚Ç¨)</label>
      <input id="p_prix" type="number" step="1" value="120000">
    </div>
    <div class="col-2">
      <label>Frais notaire (‚Ç¨)</label>
      <input id="p_notaire" type="number" step="1" value="9000">
    </div>
    <div class="col-2" style="display:flex;align-items:end">
      <button class="btn accent" id="p_add">Ajouter / Mettre √† jour</button>
    </div>
  </div>

  <!-- Tableau -->
  <div style="margin-top:12px;overflow:auto">
    <table class="table" id="p_table">
      <thead>
        <tr>
          <th>#</th><th>Type</th><th>Adresse</th>
          <th>Loyer HC</th><th>Charges</th><th>TF</th><th>Assurance</th><th>Autres/an</th><th>Vacance (mois)</th>
          <th>Prix + Notaire</th><th>Revenus/an</th><th>Charges/an</th><th>Cashflow/an</th>
          <th>Rdt brut</th><th>Rdt net</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot></tfoot>
    </table>
  </div>

  <!-- Graphiques -->
  <div class="row" style="margin-top:14px">
    <div class="col-6 card">
      <h3>üí∂ Cashflow annuel par bien</h3>
      <canvas id="chart_cash" height="200"></canvas>
    </div>
    <div class="col-6 card">
      <h3>üìä R√©partition globale</h3>
      <canvas id="chart_pie" height="200"></canvas>
    </div>
  </div>

  <!-- Exports -->
  <div style="margin-top:12px">
    <button class="btn" id="p_export_csv">Exporter CSV</button>
    <button class="btn" id="p_export_json">Exporter JSON</button>
  </div>
</section>

<!-- ===== FERMETURE DE LA PAGE ===== -->
</main>
<footer style="text-align:center;color:#8e95a3;margin:20px 0">¬© <span id="year"></span> MonBailZen ‚Äî Tous droits r√©serv√©s</footer>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ====== NAVIGATION GLOBALE ====== */
document.querySelectorAll("header .tabbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("header .tabbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab=btn.dataset.tab;
    document.querySelectorAll("main > section").forEach(sec=>sec.classList.add("hidden"));
    document.getElementById(tab).classList.remove("hidden");
    window.scrollTo({top:0,behavior:"smooth"});
  });
});
document.getElementById("year").textContent = new Date().getFullYear();

/* ====== BIENS & RENTA LOGIQUE ====== */
const PKEY="mbz.biens";
function pLoad(){ return JSON.parse(localStorage.getItem(PKEY)||"[]"); }
function pSave(arr){ localStorage.setItem(PKEY, JSON.stringify(arr)); }
let BIENS = pLoad();

function euro(n){ return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(+n||0); }
function fmt(n){ return (+n||0); }
function percent(n){ return (+(n||0)).toFixed(2)+" %"; }

function pCompute(b){
  const loyerM=fmt(b.loyer), chargesM=fmt(b.charges);
  const revenusAn = loyerM*12;
  const vacCost   = loyerM * Math.max(fmt(b.vac),0);
  const chargesAn = (chargesM*12) + fmt(b.tf) + fmt(b.assu) + fmt(b.autres) + vacCost;
  const cashflow  = revenusAn - chargesAn;
  const invest    = fmt(b.prix) + fmt(b.notaire);
  const rdtBrut   = invest>0 ? (revenusAn/invest)*100 : 0;
  const rdtNet    = invest>0 ? ((revenusAn-chargesAn)/invest)*100 : 0;
  return { revenusAn, chargesAn, cashflow, invest, rdtBrut, rdtNet, vacCost };
}

function pRenderTable(){
  const tb=document.querySelector("#p_table tbody");
  tb.innerHTML="";
  let sumRev=0,sumChg=0,sumCF=0,sumInv=0;
  BIENS.forEach((b,i)=>{
    const c=pCompute(b);
    sumRev+=c.revenusAn; sumChg+=c.chargesAn; sumCF+=c.cashflow; sumInv+=c.invest;
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${b.type}</td>
      <td>${b.adresse}</td>
      <td>${euro(b.loyer)}</td>
      <td>${euro(b.charges)}</td>
      <td>${euro(b.tf)}</td>
      <td>${euro(b.assu)}</td>
      <td>${euro(b.autres)}</td>
      <td>${b.vac||0}</td>
      <td>${euro(c.invest)}</td>
      <td><strong>${euro(c.revenusAn)}</strong></td>
      <td>${euro(c.chargesAn)}</td>
      <td><strong>${euro(c.cashflow)}</strong></td>
      <td>${percent(c.rdtBrut)}</td>
      <td>${percent(c.rdtNet)}</td>
      <td>
        <button class="btn" data-edit="${i}">‚úé</button>
        <button class="btn" data-del="${i}">üóë</button>
      </td>`;
    tb.appendChild(tr);
  });
  const tf=document.querySelector("#p_table tfoot");
  const rdtBrutG = sumInv>0 ? (sumRev/sumInv*100) : 0;
  const rdtNetG  = sumInv>0 ? ((sumRev-sumChg)/sumInv*100) : 0;
  tf.innerHTML = `
    <tr>
      <td colspan="10" style="text-align:right;font-weight:800">Totaux / Global</td>
      <td><span class="badge-total">${euro(sumRev)}</span></td>
      <td><span class="badge-total">${euro(sumChg)}</span></td>
      <td><span class="badge-total">${euro(sumCF)}</span></td>
      <td><span class="badge-total">${percent(rdtBrutG)}</span></td>
      <td><span class="badge-total">${percent(rdtNetG)}</span></td>
      <td></td>
    </tr>`;
}

function pBindActions(){
  const tb=document.querySelector("#p_table tbody");
  tb.addEventListener("click",(e)=>{
    const t=e.target;
    if(t.dataset.del){
      const i=+t.dataset.del;
      if(confirm("Supprimer ce bien ?")){
        BIENS.splice(i,1); pSave(BIENS); pRenderTable(); pRenderCharts();
      }
    }
    if(t.dataset.edit){
      const i=+t.dataset.edit; const b=BIENS[i]; if(!b) return;
      p_type.value=b.type; p_adresse.value=b.adresse; p_loyer.value=b.loyer; p_charges.value=b.charges;
      p_tf.value=b.tf; p_assu.value=b.assu; p_autres.value=b.autres; p_vac.value=b.vac; p_prix.value=b.prix; p_notaire.value=b.notaire;
      p_add.dataset.editing=i; p_add.textContent="Mettre √† jour";
      window.scrollTo({top:document.getElementById("biens").offsetTop-20,behavior:"smooth"});
    }
  });
}

function pAddOrUpdate(){
  const payload={
    type:p_type.value,
    adresse:p_adresse.value.trim(),
    loyer:+p_loyer.value||0,
    charges:+p_charges.value||0,
    tf:+p_tf.value||0,
    assu:+p_assu.value||0,
    autres:+p_autres.value||0,
    vac:+p_vac.value||0,
    prix:+p_prix.value||0,
    notaire:+p_notaire.value||0
  };
  if(!payload.adresse){ alert("Adresse requise"); return; }
  if(p_add.dataset.editing){
    BIENS[+p_add.dataset.editing]=payload;
    delete p_add.dataset.editing;
    p_add.textContent="Ajouter / Mettre √† jour";
  } else {
    BIENS.push(payload);
  }
  pSave(BIENS);
  pRenderTable(); pRenderCharts();
  p_adresse.value="";
}
document.getElementById("p_add").addEventListener("click", pAddOrUpdate);

/* Graphiques Chart.js */
let chartCash=null, chartPie=null;
function pRenderCharts(){
  const labels = BIENS.map((b,i)=> (i+1)+". "+(b.adresse||"").split(",")[0]);
  const cash = BIENS.map(b=> pCompute(b).cashflow);
  const totalRev = BIENS.reduce((a,b)=> a + pCompute(b).revenusAn, 0);
  const totalChg = BIENS.reduce((a,b)=> a + pCompute(b).chargesAn, 0);

  const ctx1=document.getElementById("chart_cash").getContext("2d");
  if(chartCash) chartCash.destroy();
  chartCash = new Chart(ctx1,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Cashflow annuel (‚Ç¨)", data:cash }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  const ctx2=document.getElementById("chart_pie").getContext("2d");
  if(chartPie) chartPie.destroy();
  chartPie = new Chart(ctx2,{
    type:"pie",
    data:{ labels:["Revenus/an","Charges/an"], datasets:[{ data:[totalRev,totalChg] }] },
    options:{ responsive:true }
  });
}

/* Exports */
document.getElementById("p_export_csv").addEventListener("click", ()=>{
  let csv="type;adresse;loyer_m;charges_m;tf_a;assu_a;autres_a;vac_mois;prix;notaire;revenus_a;charges_a;cashflow_a;rdt_brut;rdt_net\n";
  BIENS.forEach(b=>{
    const c=pCompute(b);
    csv += [
      b.type,b.adresse,b.loyer,b.charges,b.tf,b.assu,b.autres,b.vac,b.prix,b.notaire,
      c.revenusAn,c.chargesAn,c.cashflow,c.rdtBrut.toFixed(2),c.rdtNet.toFixed(2)
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(";") + "\n";
  });
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download="biens_renta.csv"; a.click(); URL.revokeObjectURL(a.href);
});

document.getElementById("p_export_json").addEventListener("click", ()=>{
  const s = JSON.stringify({biens:BIENS, calc:BIENS.map(b=>({adresse:b.adresse,...pCompute(b)}))}, null, 2);
  const blob=new Blob([s],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download="biens_renta.json"; a.click(); URL.revokeObjectURL(a.href);
});

/* Init */
pRenderTable(); pBindActions(); pRenderCharts();
</script>

</body>
</html>

</section>
