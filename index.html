<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MonBailZen ‚Äî Baux ‚Ä¢ EDL ‚Ä¢ IRL ‚Ä¢ Exports ‚Ä¢ Tarifs</title>
<meta name="description" content="MonBailZen : baux complets, EDL illimit√©s, comptabilit√© (IRL), exports CSV/JSON, signature (d√©mo), tarifs (mensuel/annuel/pause)."/>
<style>
:root{--bg:#0b0f14;--bg2:#0f1520;--card:#121924;--muted:#9fb3c5;--text:#e7f0fb;--accent:#7CFF6B;--ring:0 0 0 3px rgba(124,255,107,.3);--shadow:0 8px 25px rgba(0,0,0,.35);--radius:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:
radial-gradient(1200px 600px at 70% -10%,rgba(124,255,107,.08),transparent 60%),var(--bg);line-height:1.45}
a{color:inherit;text-decoration:none}
.container{max-width:1180px;margin:0 auto;padding:24px}
.nav{position:sticky;top:0;z-index:50;background:rgba(11,15,20,.8);backdrop-filter:blur(12px);border-bottom:1px solid #182533}
.nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.badge{width:36px;height:28px;border-radius:8px;background:var(--accent);color:#041105;display:grid;place-items:center;font-weight:900}
.menu{display:flex;flex-wrap:wrap;gap:10px}
.tabbtn,.btn{padding:10px 14px;border-radius:999px;border:1px solid #223143;background:#0e141c;color:var(--text);cursor:pointer}
.menu .tabbtn{border-radius:10px}
.tabbtn.active,.tabbtn:hover{background:rgba(124,255,107,.18);color:#0c1c0c}
.btn.accent{background:var(--accent);color:#041105;border-color:transparent;font-weight:800}
.btn.ghost{background:transparent}
.btn:focus-visible{outline:none;box-shadow:var(--ring)}
.grid{display:grid;gap:18px}
.card{background:linear-gradient(180deg,var(--card),#0f1520);border:1px solid #1a2533;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
h2{margin:4px 0 8px}
label{display:block;margin:10px 0 6px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #223143;background:#0e141c;color:var(--text)}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-12{grid-column:span 12}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid #223143;padding:8px;text-align:left}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border:1px solid #223143;border-radius:999px;background:#0e1720;color:var(--muted);font-size:.9rem}
.note{color:var(--muted);font-size:.92rem}
.hidden{display:none}
footer{text-align:center;color:var(--muted);margin:32px 0}
.ribbon{display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(124,255,107,.16);color:#1a2;border:1px solid rgba(124,255,107,.35);font-weight:800}
.price{display:flex;align-items:baseline;gap:6px;margin:6px 0 12px}
.price .amt{font-size:38px;font-weight:900}
.segwrap{display:flex;gap:6px;background:#0b1218;border:1px solid #1b2a38;border-radius:999px;padding:6px;flex-wrap:wrap}
.seg{padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted)}
.seg[aria-checked=true]{background:var(--accent);color:#041105;font-weight:800}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px}
.win{background:#0f1620;border:1px solid #1b2a38;border-radius:18px;max-width:720px;width:100%;padding:16px}
@media (max-width:980px){.row{grid-template-columns:repeat(1,1fr)}}
@media print{body{background:#fff;color:#000}.nav,.no-print{display:none!important}.print-block{display:block}}
</style>
</head>
<body>
<nav class="nav">
  <div class="container nav-inner">
    <div class="brand"><div class="badge">MBZ</div>MonBailZen</div>
    <div class="menu no-print" id="menu">
      <button class="tabbtn active" data-tab="baux">Baux</button>
      <button class="tabbtn" data-tab="edl">EDL</button>
      <button class="tabbtn" data-tab="compta">Comptabilit√©</button>
      <button class="tabbtn" data-tab="export">Exports</button>
      <button class="tabbtn" data-tab="tarifs">Tarifs</button>
      <button class="btn ghost" id="resetAll">R√©initialiser tout</button>
    </div>
  </div>
</nav>

<main class="container grid">
  <!-- ================== BAUX ================== -->
  <section id="baux" class="card">
    <h2>üìÑ G√©n√©rateur de Bail (clauses & annexes)</h2>
    <div class="row">
      <div class="col-6"><label>Bailleur</label><input id="b_bailleur" /></div>
      <div class="col-6"><label>Locataire</label><input id="b_locataire" /></div>
      <div class="col-12"><label>Adresse du logement</label><input id="b_adresse" /></div>
      <div class="col-3"><label>Loyer (‚Ç¨)</label><input type="number" id="b_loyer" value="650" /></div>
      <div class="col-3"><label>Charges (‚Ç¨)</label><input type="number" id="b_charges" value="40" /></div>
      <div class="col-3"><label>D√©p√¥t (‚Ç¨)</label><input type="number" id="b_depot" value="650" /></div>
      <div class="col-3"><label>√âch√©ance (jour)</label><input type="number" id="b_echeance" value="5" /></div>
      <div class="col-4"><label>Type</label>
        <select id="b_type"><option>Location vide</option><option>Meubl√©e</option><option>Saisonni√®re</option></select>
      </div>
      <div class="col-4"><label>D√©but</label><input id="b_debut" type="date" /></div>
      <div class="col-4"><label>Dur√©e (mois)</label><input id="b_duree" type="number" value="12" /></div>
    </div>

    <h3>Clauses (activer/d√©sactiver)</h3>
    <div class="row">
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="caution" checked/> Caution solidaire</label></div>
      <div class="col-6"><label>Nom caution</label><input id="cl_caution_nom" placeholder="Nom Pr√©nom"/></div>
      <div class="col-3"><label>Montant garanti (‚Ç¨)</label><input id="cl_caution_montant" type="number" value="1000"/></div>
      <div class="col-3"><label>Dur√©e (mois)</label><input id="cl_caution_duree" type="number" value="12"/></div>

      <div class="col-12"><label><input type="checkbox" class="clause" data-key="irl" checked/> Indexation annuelle IRL</label></div>
      <div class="col-4"><label>IRL ancien</label><input id="cl_irl_a" type="number" step="0.01" value="140.97"/></div>
      <div class="col-4"><label>IRL nouveau</label><input id="cl_irl_n" type="number" step="0.01" value="146.21"/></div>
      <div class="col-4"><label>Date anniversaire</label><input id="cl_irl_date" type="date"/></div>

      <div class="col-12"><label><input type="checkbox" class="clause" data-key="assurance" checked/> Assurance obligatoire</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="retard" checked/> P√©nalit√©s de retard</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="entretien" checked/> Entretien & r√©parations locatives</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="sousloc" checked/> Sous-location interdite</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="resolutoire" checked/> Clause r√©solutoire</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="preavis" checked/> Pr√©avis & remise des cl√©s</label></div>
    </div>

    <h3>Annexes</h3>
    <div class="row">
      <div class="col-8"><input id="annexe_nom" placeholder="DPE, ERP/ERNMT, Inventaire, EDL sign√©..." /></div>
      <div class="col-4"><button class="btn" id="annexe_add">Ajouter</button></div>
      <div class="col-12"><ul id="annexe_list" class="note" style="padding-left:18px;margin:8px 0"></ul></div>
    </div>

    <div class="row">
      <div class="col-12">
        <button class="btn accent" id="b_preview">Pr√©visualiser (impression/PDF)</button>
        <button class="btn" id="b_doc">T√©l√©charger (.doc)</button>
        <button class="btn" id="b_json">Exporter JSON</button>
      </div>
    </div>

    <div id="bail_print" class="print-block hidden" style="background:#fff;color:#000;padding:16px">
      <h2 style="margin:0 0 8px">Bail d'habitation ‚Äî MonBailZen</h2>
      <div id="bail_content" style="white-space:pre-wrap"></div>
      <p style="margin-top:24px">Fait le <span id="bail_date"></span> ‚Äî Signatures :</p>
      <div style="display:flex;gap:40px;margin-top:30px"><div>Le Bailleur</div><div>Le Locataire</div></div>
    </div>
  </section>

  <!-- ================== EDL ================== -->
  <section id="edl" class="card hidden">
    <h2>üõ†Ô∏è EDL illimit√©s (√©l√©ments, √©tats, photos, anomalies)</h2>
    <div class="row">
      <div class="col-6"><label>Bien</label><input id="e_bien" placeholder="Ex: 4 rue Quiquerue, Ault"/></div>
      <div class="col-6"><label>Pi√®ce rapide</label>
        <div class="row">
          <div class="col-6"><input id="e_piece" placeholder="Salon, Chambre 1, SDB‚Ä¶"/></div>
          <div class="col-6"><button class="btn accent" id="e_add_piece">Ajouter (3 lignes)</button></div>
        </div>
      </div>
      <div class="col-12">
        <table class="table" id="e_table">
          <thead><tr><th>Pi√®ce</th><th>√âl√©ment</th><th>√âtat</th><th>Photo (URL)</th><th>Anomalie</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn" id="e_add_ligne">Ajouter ligne</button>
        <button class="btn" id="e_csv">Exporter CSV</button>
        <button class="btn" id="e_json">Exporter JSON</button>
      </div>
    </div>
  </section>

  <!-- ================== COMPTA / IRL ================== -->
  <section id="compta" class="card hidden">
    <h2>üìà Comptabilit√© (charges) & Indexation IRL</h2>
    <div class="row">
      <div class="col-4"><label>Loyer hors charges (‚Ç¨)</label><input id="c_loyer" type="number" value="650"/></div>
      <div class="col-4"><label>IRL ancien</label><input id="c_irl_ancien" type="number" step="0.01" value="140.97"/></div>
      <div class="col-4"><label>IRL nouveau</label><input id="c_irl_nouveau" type="number" step="0.01" value="146.21"/></div>
      <div class="col-4"><label>√âlec/mois (‚Ç¨)</label><input id="c_elec" type="number" value="60"/></div>
      <div class="col-4"><label>Eau/mois (‚Ç¨)</label><input id="c_eau" type="number" value="25"/></div>
      <div class="col-4"><label>Internet/mois (‚Ç¨)</label><input id="c_net" type="number" value="30"/></div>
      <div class="col-12"><button class="btn accent" id="c_calc">Calculer</button></div>
      <div class="col-12">
        <table class="table" id="c_table"><thead><tr><th>Base</th><th>IRL ancien</th><th>IRL nouveau</th><th>Loyer index√©</th><th>Charges</th><th>Total mensuel</th></tr></thead><tbody></tbody></table>
      </div>
      <p class="note">Formule IRL : loyer index√© = loyer de base √ó (IRL_nouveau / IRL_ancien).</p>
    </div>
  </section>

  <!-- ================== EXPORTS ================== -->
  <section id="export" class="card hidden">
    <h2>üì§ Exports globaux</h2>
    <p class="note">Baux + EDL + Compta en CSV/JSON.</p>
    <div class="chips">
      <button class="btn" id="x_csv">Exporter tout en CSV</button>
      <button class="btn" id="x_json">Exporter tout en JSON</button>
    </div>
    <pre id="x_preview" style="white-space:pre-wrap;background:#0b1218;border:1px solid #223143;padding:12px;border-radius:12px;margin-top:12px;color:#cfe7ff"></pre>
  </section>

  <!-- ================== TARIFS ================== -->
  <section id="tarifs" class="card hidden">
    <h2>üí∂ Tarifs</h2>
    <div class="chips"><span class="chip">Sans engagement</span><span class="chip">Annulation en 1 clic</span><span class="chip">Pause & sauvegarde</span></div>
    <div style="height:10px"></div>
    <div class="segwrap no-print">
      <button class="seg" aria-checked="true" data-plan="mensuel">Mensuel</button>
      <button class="seg" data-plan="annuel">Annuel (-2 mois)</button>
      <button class="seg" data-plan="pause">Pause & sauvegarde</button>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="col-4 card">
        <div class="ribbon">Gratuit</div>
        <h3>Starter</h3>
        <div class="price"><span class="amt" data-amt="starter">0‚Ç¨</span><small data-period>/ mois</small></div>
        <ul class="note"><li>1 bien</li><li>EDL illimit√©s (d√©taill√©s)</li><li>D√©mo locale</li><li>Export CSV</li></ul>
        <button class="btn">Essayer</button>
      </div>
      <div class="col-4 card">
        <h3>Pro</h3>
        <div class="price"><span class="amt" data-amt="pro">9‚Ç¨</span><small data-period>/ mois</small></div>
        <ul class="note"><li>Jusqu'√† 10 biens</li><li>Logo propri√©taire</li><li>Compta + IRL + exports</li><li>Signature (d√©mo)</li></ul>
        <button class="btn accent">Choisir</button>
      </div>
      <div class="col-4 card">
        <h3>Business</h3>
        <div class="price"><span class="amt" data-amt="business">19‚Ç¨</span><small data-period>/ mois</small></div>
        <ul class="note"><li>Biens illimit√©s</li><li>Support prioritaire</li><li>√âquipe & espaces</li><li>Exports avanc√©s</li></ul>
        <button class="btn">Choisir</button>
      </div>
    </div>
    <p class="note">Annuel = 10 mois pay√©s / 12 d‚Äôacc√®s. Pause & sauvegarde = lecture seule (2‚Ç¨/mois).</p>
  </section>
</main>

<footer>¬© <span id="year"></span> MonBailZen ‚Äî Tous droits r√©serv√©s</footer>

<!-- ================== MODAL SIGNATURE (d√©mo) ================== -->
<div class="modal" id="signModal" aria-hidden="true">
  <div class="win">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Signature (d√©mo)</h3>
      <button class="btn" id="closeSign">Fermer</button>
    </div>
    <p class="note">D√©mo locale : import image de signature, insertion sur canvas, impression.</p>
    <div class="row">
      <div class="col-6"><label>Nom signataire</label><input id="s_nom" placeholder="Nom Pr√©nom"/></div>
      <div class="col-6"><label>Image de signature</label><input type="file" id="s_file" accept="image/*"/></div>
      <div class="col-12"><canvas id="s_canvas" width="600" height="240" style="background:#fff;border-radius:12px"></canvas></div>
      <div class="col-12"><button class="btn accent" id="s_draw">Ins√©rer</button><button class="btn" id="s_clear">Effacer</button><button class="btn" id="s_print">Imprimer</button></div>
    </div>
  </div>
</div>

<script>
// ========= CONFIG TARIFS =========
const PRICES = {
  mensuel : { starter:"0‚Ç¨", pro:"9‚Ç¨",  business:"19‚Ç¨",  period:"/ mois" },
  annuel  : { starter:"0‚Ç¨", pro:"90‚Ç¨", business:"190‚Ç¨", period:"/ an" },
  pause   : { starter:"0‚Ç¨", pro:"2‚Ç¨",  business:"2‚Ç¨",   period:"/ mois (lecture seule)" }
};

// ========= PERSISTENCE =========
const store = {
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
  get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch(e){ return def } },
  reset(){ localStorage.clear(); location.reload(); }
};
resetAll.onclick=()=>{ if(confirm("R√©initialiser toutes les donn√©es locales ?")) store.reset(); };
year.textContent = new Date().getFullYear();

// ========= NAV =========
document.querySelectorAll(".tabbtn").forEach(b=>{
  b.addEventListener("click", ()=>{
    document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll("main>section").forEach(s=>s.classList.add("hidden"));
    document.getElementById(b.dataset.tab).classList.remove("hidden");
    window.scrollTo({top:0,behavior:"smooth"});
  });
});

// ========= BAUX =========
const B_KEYS = ["b_bailleur","b_locataire","b_adresse","b_loyer","b_charges","b_depot","b_echeance","b_type","b_debut","b_duree",
"cl_caution_nom","cl_caution_montant","cl_caution_duree","cl_irl_a","cl_irl_n","cl_irl_date"];
const C_KEYS = ["caution","irl","assurance","retard","entretien","sousloc","resolutoire","preavis"];
function loadBail(){
  const b = store.get("mbz.bail",{}); B_KEYS.forEach(id=>{ const el=document.getElementById(id); if(el && b[id]!=null) el.value=b[id]; });
  const c = store.get("mbz.clauses",{}); C_KEYS.forEach(k=>{ const el=document.querySelector('.clause[data-key="'+k+'"]'); if(el && c[k]!=null) el.checked=c[k]; });
  const ann = store.get("mbz.annexes",[]); ann.forEach(addAnnexeLi);
}
function saveBail(){
  const b={}; B_KEYS.forEach(id=>{ const el=document.getElementById(id); if(el) b[id]=el.value; }); store.set("mbz.bail", b);
  const c={}; C_KEYS.forEach(k=>{ const el=document.querySelector('.clause[data-key="'+k+'"]'); if(el) c[k]=el.checked; }); store.set("mbz.clauses", c);
  const anns=[...document.querySelectorAll("#annexe_list li")].map(li=>li.textContent); store.set("mbz.annexes", anns);
}
document.addEventListener("input",(e)=>{ if(e.target.closest("#baux")) saveBail(); });
function clauseText(){
  const c = store.get("mbz.clauses",{}); const get=id=>(document.getElementById(id)||{}).value;
  let out="";
  if(c.caution) out += `\nCaution solidaire : ${get("cl_caution_nom")} garantit ${get("cl_caution_montant")} ‚Ç¨ pour ${get("cl_caution_duree")} mois (renonciation discussion/division).`;
  if(c.irl) out += `\nIndexation IRL : base √ó (IRL_nouveau / IRL_ancien). R√©f ${get("cl_irl_a")}‚Üí${get("cl_irl_n")} ; date ${get("cl_irl_date")||"anniversaire"}.`;
  if(c.assurance) out += `\nAssurance : attestation sous 15 jours, d√©faut = clause r√©solutoire.`;
  if(c.retard) out += `\nRetard : p√©nalit√©s et frais de relance.`;
  if(c.entretien) out += `\nEntretien : r√©parations locatives (D√©cret 87-712).`;
  if(c.sousloc) out += `\nSous-location : interdite sans accord √©crit.`;
  if(c.resolutoire) out += `\nClause r√©solutoire : impay√©s, absence d‚Äôassurance, troubles.`;
  if(c.preavis) out += `\nPr√©avis & remise des cl√©s selon r√©gime.`;
  const anns = store.get("mbz.annexes",[]); if(anns.length) out += `\nAnnexes : ${anns.join(", ")}.`;
  return out;
}
function bailData(){
  const b = store.get("mbz.bail",{});
  return {
    bailleur:b.b_bailleur||"‚Äî", locataire:b.b_locataire||"‚Äî", adresse:b.b_adresse||"‚Äî",
    loyer:parseFloat(b.b_loyer||0), charges:parseFloat(b.b_charges||0), depot:parseFloat(b.b_depot||0),
    echeance:parseInt(b.b_echeance||5), type:b.b_type||"Location vide",
    debut:b.b_debut||"‚Äî", duree:parseInt(b.b_duree||12)
  };
}
function bailTexte(d){
  const total=(d.loyer+d.charges).toFixed(2);
  return `BAIL D'HABITATION ‚Äî MonBailZen

Entre les soussign√©s :
- Bailleur : ${d.bailleur}
- Locataire : ${d.locataire}

Objet : ${d.type}
Logement : ${d.adresse}

Conditions financi√®res :
- Loyer mensuel hors charges : ${d.loyer.toFixed(2)} ‚Ç¨
- Provision sur charges : ${d.charges.toFixed(2)} ‚Ç¨
- Loyer mensuel total : ${total} ‚Ç¨
- D√©p√¥t de garantie : ${d.depot.toFixed(2)} ‚Ç¨
- √âch√©ance : le ${d.echeance} de chaque mois

Dur√©e : ${d.duree} mois √† compter du ${d.debut}
${clauseText()}
`;
}
function addAnnexeLi(name){
  const li=document.createElement("li"); li.textContent=name; li.style.cursor="pointer"; li.title="Cliquer pour supprimer";
  li.addEventListener("click",()=>{ li.remove(); saveBail(); });
  document.getElementById("annexe_list").appendChild(li);
}
annexe_add.onclick=()=>{ if(annexe_nom.value.trim()){ addAnnexeLi(annexe_nom.value.trim()); annexe_nom.value=""; saveBail(); } };
b_preview.onclick=()=>{ const t=bailTexte(bailData()); bail_content.textContent=t; bail_date.textContent=new Date().toLocaleDateString("fr-FR"); bail_print.classList.remove("hidden"); setTimeout(()=>window.print(),50); };
b_doc.onclick=()=>{ const t=bailTexte(bailData()); const blob=new Blob([t],{type:"application/msword"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bail_monbailzen.doc"; a.click(); URL.revokeObjectURL(a.href); };
b_json.onclick=()=>{ const data={...bailData(),clauses:store.get("mbz.clauses",{}),annexes:store.get("mbz.annexes",[])}; const s=JSON.stringify(data,null,2); const blob=new Blob([s],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bail_monbailzen.json"; a.click(); URL.revokeObjectURL(a.href); };
loadBail();

// ========= EDL =========
const etBody = document.querySelector("#e_table tbody");
const ETATS = ["Neuf","Tr√®s bon","Bon","Moyen","√Ä r√©nover"];
const ELS = ["Murs","Plafond","Sol","Porte","Fen√™tre","Prises","√âclairage","Radiateurs","√âlectrom√©nager","Divers"];
function addEdlRow(piece="Salon", el="Murs", etat="Bon", photo="", anom=""){
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td><input value="${piece}"/></td>
    <td><select>${ELS.map(x=>`<option ${x===el?'selected':''}>${x}</option>`).join("")}</select></td>
    <td><select>${ETATS.map(x=>`<option ${x===etat?'selected':''}>${x}</option>`).join("")}</select></td>
    <td><input value="${photo}" placeholder="https://..."/></td>
    <td><input value="${anom}" placeholder="Anomalie/Commentaire"/></td>
    <td><button class="btn" data-del>Ligne -</button></td>`;
  etBody.appendChild(tr);
}
function edlAsArray(){
  return [...etBody.querySelectorAll("tr")].map(r=>{
    const t=r.querySelectorAll("td");
    return {
      piece: t[0].querySelector("input").value,
      element: t[1].querySelector("select").value,
      etat: t[2].querySelector("select").value,
      photo: t[3].querySelector("input").value,
      anomalie: t[4].querySelector("input").value
    };
  });
}
function saveEDL(){ store.set("mbz.edl", edlAsArray()); }
function loadEDL(){
  (store.get("mbz.edl",[])||[]).forEach(x=> addEdlRow(x.piece,x.element,x.etat,x.photo,x.anomalie));
  if(etBody.children.length===0){ for(let i=0;i<3;i++) addEdlRow("Salon"); }
}
e_add_ligne.onclick = ()=> addEdlRow(e_piece.value||"Pi√®ce");
e_add_piece.onclick = ()=> { const p=e_piece.value||"Pi√®ce"; for(let i=0;i<3;i++) addEdlRow(p); saveEDL(); };
etBody.addEventListener("click",(e)=>{ if(e.target.dataset.del){ e.target.closest("tr").remove(); saveEDL(); }});
document.addEventListener("input",(e)=>{ if(e.target.closest("#e_table")) saveEDL(); });
e_csv.onclick=()=>{ const bien=e_bien.value||"Bien"; const arr=edlAsArray(); const header="Bien;Pi√®ce;√âl√©ment;√âtat;Photo;Anomalie\n"; const body=arr.map(x=>[bien,x.piece,x.element,x.etat,x.photo,x.anomalie].map(v=>`"${(v||"").replace(/"/g,'""')}"`).join(";")).join("\n"); const blob=new Blob([header+body],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="edl_monbailzen.csv"; a.click(); URL.revokeObjectURL(a.href); };
e_json.onclick=()=>{ const data={bien:e_bien.value||"Bien",lignes:edlAsArray()}; const s=JSON.stringify(data,null,2); const blob=new Blob([s],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="edl_monbailzen.json"; a.click(); URL.revokeObjectURL(a.href); };
loadEDL();

// ========= COMPTA / IRL =========
function saveCompta(){ const o={ base:parseFloat(c_loyer.value||0), irlA:parseFloat(c_irl_ancien.value||1), irlN:parseFloat(c_irl_nouveau.value||1), elec:parseFloat(c_elec.value||0), eau:parseFloat(c_eau.value||0), net:parseFloat(c_net.value||0) }; store.set("mbz.compta", o); return o; }
function loadCompta(){ const o=store.get("mbz.compta",null); if(!o) return; c_loyer.value=o.base; c_irl_ancien.value=o.irlA; c_irl_nouveau.value=o.irlN; c_elec.value=o.elec; c_eau.value=o.eau; c_net.value=o.net; }
c_calc.onclick=()=>{ const o=saveCompta(); const indexe=(o.base*(o.irlN/o.irlA)); const charges=o.elec+o.eau+o.net; const total=indexe+charges; document.querySelector("#c_table tbody").innerHTML = `<tr><td>${o.base.toFixed(2)} ‚Ç¨</td><td>${o.irlA}</td><td>${o.irlN}</td><td><strong>${indexe.toFixed(2)} ‚Ç¨</strong></td><td>${charges.toFixed(2)} ‚Ç¨</td><td><strong>${total.toFixed(2)} ‚Ç¨</strong></td></tr>`; };
loadCompta();

// ========= EXPORT GLOBAL =========
function bailObj(){ return { ...bailData(), clauses: store.get("mbz.clauses",{}), annexes: store.get("mbz.annexes",[]) }; }
x_csv.onclick=()=>{ const edl=store.get("mbz.edl",[]); const bail=bailObj(); const comp=store.get("mbz.compta",{}); let csv="section;champ;valeur\n"; Object.entries(bail).forEach(([k,v])=> csv += `bail;${k};${(typeof v==='object')?JSON.stringify(v):v}\n`); Object.entries(comp).forEach(([k,v])=> csv += `compta;${k};${v}\n`); edl.forEach((x,i)=> Object.entries(x).forEach(([k,v])=> csv += `edl_${i+1};${k};${v}\n`)); const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="monbailzen_export.csv"; a.click(); URL.revokeObjectURL(a.href); };
x_json.onclick=()=>{ const data={ bail:bailObj(), edl:store.get("mbz.edl",[]), compta:store.get("mbz.compta",{}) }; const s=JSON.stringify(data,null,2); x_preview.textContent=s; const blob=new Blob([s],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="monbailzen_export.json"; a.click(); URL.revokeObjectURL(a.href); };

// ========= TARIFS =========
const segs=document.querySelectorAll(".seg"),pEls=document.querySelectorAll("[data-period]"),amt={ starter:document.querySelector('[data-amt="starter"]'), pro:document.querySelector('[data-amt="pro"]'), business:document.querySelector('[data-amt="business"]') };
function applyPlan(plan){ const p=PRICES[plan]; amt.starter.textContent=p.starter; amt.pro.textContent=p.pro; amt.business.textContent=p.business; pEls.forEach(el=> el.textContent = " " + p.period); }
segs.forEach(b=> b.addEventListener("click", ()=>{ segs.forEach(s=> s.setAttribute("aria-checked","false")); b.setAttribute("aria-checked","true"); applyPlan(b.dataset.plan); }));
applyPlan("mensuel");

// ========= SIGNATURE (d√©mo) =========
const signModal=document.getElementById("signModal"); function openSign(){ signModal.style.display="flex"; signModal.setAttribute("aria-hidden","false"); }
closeSign.onclick=()=>{ signModal.style.display="none"; signModal.setAttribute("aria-hidden","true"); };
const sCanvas=document.getElementById("s_canvas"), ctx=sCanvas.getContext("2d"); function drawBoard(){ ctx.fillStyle="#fff"; ctx.fillRect(0,0,sCanvas.width,sCanvas.height); ctx.fillStyle="#000"; ctx.font="16px sans-serif"; ctx.fillText("Signature de :", 20, 32); }
drawBoard();
s_draw.onclick=()=>{ drawBoard(); const nom=s_nom.value||"Nom"; ctx.fillStyle="#000"; ctx.fillText(nom, 140, 32); const f=s_file.files[0]; if(!f){ ctx.font="48px cursive"; ctx.fillText("~ signature ~", 140, 140); return; } const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.onload=()=>ctx.drawImage(img, 40, 60, 520, 150); img.src=e.target.result; }; r.readAsDataURL(f); };
s_clear.onclick=drawBoard;
s_print.onclick=()=>window.print();
</script>
</body>
</html>
