
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MonBailZen ‚Äì Baux ‚Ä¢ EDL ‚Ä¢ IRL ‚Ä¢ Signatures ‚Ä¢ Biens & Renta</title>
<style>
/* ---------- Th√®me Gold & Dark ---------- */
:root{
  --bg:#0a0b0f; --bg2:#0f1117; --card:#11141b; --muted:#c7c9d1; --text:#f4f5f7;
  --accent:#d4af37; --accent-weak:rgba(212,175,55,.16); --ring:0 0 0 3px rgba(212,175,55,.35);
  --shadow:0 8px 25px rgba(0,0,0,.45); --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
header{position:sticky;top:0;z-index:20;background:linear-gradient(90deg,#0a0b0f,#14161c);border-bottom:1px solid #232937;padding:10px 14px}
.container{max-width:1180px;margin:0 auto}
.head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.badge{width:36px;height:28px;border-radius:8px;background:var(--accent);color:#211b05;display:grid;place-items:center;font-weight:900}
nav{display:flex;flex-wrap:wrap;gap:8px}
.tabbtn,.btn{padding:8px 12px;border-radius:10px;border:1px solid #2a2c33;background:#0e1219;color:var(--text);cursor:pointer}
.tabbtn.active,.tabbtn:hover{background:var(--accent-weak);color:#1c1a11;border-color:var(--accent)}
.btn.accent{background:var(--accent);color:#1d1604;border-color:transparent;font-weight:800}
.btn.ghost{background:transparent}
.btn:focus-visible{outline:none;box-shadow:var(--ring)}
main{padding:16px}
.grid{display:grid;gap:16px}
.card{background:linear-gradient(180deg,var(--card),#0e1219);border:1px solid #232937;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
h2{margin:6px 0 10px;color:var(--accent)}
label{display:block;margin:8px 0 4px;color:var(--muted)}
input,select,textarea{width:100%;padding:9px 10px;border-radius:12px;border:1px solid #30343e;background:#0d1117;color:#f2f4f7}
input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring);border-color:var(--accent)}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-5{grid-column:span 5}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
.note{color:var(--muted);font-size:.92rem}
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;background:#0d1117;border:1px solid #262c3a;border-radius:12px;overflow:hidden}
.table th{background:linear-gradient(180deg,#141926,#101521);color:#f6f6f6;text-align:left;padding:10px 12px;position:sticky;top:0}
.table td{padding:10px 12px;border-top:1px solid #1f2532}
.table tbody tr:nth-child(even){background:#0f1420}
.table tfoot td{font-weight:800;border-top:2px solid #31394b}
.badge-total{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--accent-weak);border:1px solid rgba(212,175,55,.4);color:#e9d79a}
.hidden{display:none}
.print-block{display:none}
@media print{header,.no-print{display:none!important}body{background:#fff;color:#000}.print-block{display:block}}
</style>
</head>
<body>
<header>
  <div class="container head">
    <div class="brand"><div class="badge">MBZ</div>MonBailZen</div>
    <nav class="no-print">
      <button class="tabbtn active" data-tab="home">Accueil</button>
      <button class="tabbtn" data-tab="baux">Baux</button>
      <button class="tabbtn" data-tab="edl">EDL</button>
      <button class="tabbtn" data-tab="biens">Biens & Renta</button>
      <button class="tabbtn" data-tab="sign">Signatures</button>
      <button class="btn ghost" id="resetAll">R√©initialiser</button>
    </nav>
  </div>
</header>

<main class="container grid">
  <!-- ACCUEIL + Tarifs -->
  <section id="home" class="card">
    <h2>Bienvenue üëã</h2>
    <p>Cr√©ez vos <strong>baux complets</strong>, r√©alisez des <strong>EDL avanc√©s</strong>, suivez vos <strong>biens & rentabilit√©s</strong>, g√©rez <strong>IRL/assurance</strong> avec courriers automatiques, et signez <strong>manuscrit ou import</strong>. Th√®me <em>gold & dark</em> ‚ú®.</p>

    <h3>üí∞ Tarifs</h3>
    <table class="table">
      <thead><tr><th>Offre</th><th>Mensuel</th><th>Annuel</th><th>Inclus</th></tr></thead>
      <tbody>
        <tr><td>Essai 7 j</td><td>0 ‚Ç¨</td><td>‚Äî</td><td>1 bail + 1 EDL entr√©e</td></tr>
        <tr><td>Unitaire</td><td>7,90 ‚Ç¨</td><td>‚Äî</td><td>1 bail + 1 EDL entr√©e + cr√©dit sortie 0,5</td></tr>
        <tr><td>Starter</td><td>24 ‚Ç¨/mois</td><td>240 ‚Ç¨/an</td><td>3 baux + 3 EDL + IRL automatique + emails</td></tr>
        <tr><td>Pro</td><td>59 ‚Ç¨/mois</td><td>590 ‚Ç¨/an</td><td>Illimit√© + logo + exports compta</td></tr>
        <tr><td>Pause & sauvegarde</td><td>2 ‚Ç¨/mois</td><td>20 ‚Ç¨/an</td><td>Lecture seule + conservation</td></tr>
      </tbody>
    </table>
      <!-- BAUX -->
  <section id="baux" class="card hidden">
    <h2>üìÑ G√©n√©rateur de Bail (vide ‚Ä¢ meubl√© ‚Ä¢ saisonnier ‚Ä¢ mobilit√©)</h2>

    <div class="row">
      <div class="col-6"><label>Bailleur</label><input id="b_bailleur"></div>
      <div class="col-6"><label>Locataire</label><input id="b_locataire"></div>
      <div class="col-12"><label>Adresse du logement</label><input id="b_adresse"></div>

      <div class="col-3"><label>Loyer HC (‚Ç¨)</label><input id="b_loyer" type="number" value="650"></div>
      <div class="col-3"><label>Charges (‚Ç¨)</label><input id="b_charges" type="number" value="40"></div>
      <div class="col-3"><label>D√©p√¥t (‚Ç¨)</label><input id="b_depot" type="number" value="650"></div>
      <div class="col-3"><label>√âch√©ance (jour)</label><input id="b_echeance" type="number" value="5"></div>

      <div class="col-4">
        <label>Type de bail</label>
        <select id="b_type">
          <option>Location vide</option>
          <option>Meubl√©e</option>
          <option>Saisonnier</option>
          <option>Mobilit√©</option>
        </select>
      </div>
      <div class="col-4"><label>D√©but de bail</label><input id="b_debut" type="date"></div>
      <div class="col-2"><label>Dur√©e (mois)</label><input id="b_duree" type="number" value="12"></div>
      <div class="col-2"><label>Pr√©avis (mois)</label><input id="b_preavis" type="number" value="1"></div>
      <div class="col-12"><p id="b_rule_note" class="note">R√®gles auto selon le type (dur√©e/pr√©avis).</p></div>
    </div>

    <h3>Clauses & options</h3>
    <div class="row">
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="caution" checked> Caution solidaire</label></div>
      <div class="col-6"><label>Nom de la caution</label><input id="cl_caution_nom" placeholder="Nom Pr√©nom"></div>
      <div class="col-3"><label>Montant garanti (‚Ç¨)</label><input id="cl_caution_montant" type="number" value="1000"></div>
      <div class="col-3"><label>Dur√©e caution (mois)</label><input id="cl_caution_duree" type="number" value="12"></div>

      <div class="col-12"><label><input type="checkbox" class="clause" data-key="irl" checked> R√©vision IRL</label></div>
      <div class="col-4"><label>IRL ancien</label><input id="cl_irl_a" type="number" step="0.01" value="140.97"></div>
      <div class="col-4"><label>IRL nouveau</label><input id="cl_irl_n" type="number" step="0.01" value="146.21"></div>
      <div class="col-4"><label>Date anniversaire</label><input id="cl_irl_date" type="date"></div>

      <div class="col-12"><label><input type="checkbox" class="clause" data-key="assurance" checked> Assurance habitation</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="entretien" checked> Entretien & r√©parations locatives</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="resolutoire" checked> Clause r√©solutoire</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="sousloc" checked> Sous-location interdite</label></div>
      <div class="col-12"><label><input type="checkbox" class="clause" data-key="preavis" checked> Pr√©avis & remise des cl√©s</label></div>
    </div>

    <h3>Annexes</h3>
    <div class="row">
      <div class="col-8"><input id="annexe_nom" placeholder="DPE, ERP, EDL, Inventaire, ..."></div>
      <div class="col-4"><button class="btn" id="annexe_add">Ajouter annexe</button></div>
      <div class="col-12"><ul id="annexe_list" class="note" style="padding-left:18px;margin:8px 0"></ul></div>
      <div class="col-12"><label>Annexe libre (texte)</label><textarea id="annexe_libre" rows="6" placeholder="Contenu libre √† joindre au bail"></textarea></div>
    </div>

    <div class="row">
      <div class="col-12">
        <button class="btn accent" id="b_preview">Aper√ßu / Imprimer</button>
        <button class="btn" id="b_doc">T√©l√©charger .doc</button>
        <button class="btn" id="b_json">Exporter JSON</button>
        <button class="btn" id="b_full">Bail complet (l√©gal)</button>
      </div>
    </div>

    <h3>Pr√©visualisation ‚Äî Clause Caution (auto)</h3>
    <pre id="clause_caution_preview" class="note" style="white-space:pre-wrap;background:#0b0e15;border:1px solid #232937;padding:10px;border-radius:10px"></pre>

    <!-- Impression bail "simple" -->
    <div id="bail_print" class="print-block" style="background:#fff;color:#000;padding:16px">
      <h2 style="margin:0 0 8px">Bail d'habitation ‚Äî MonBailZen</h2>
      <div id="bail_content" style="white-space:pre-wrap"></div>
      <p style="margin-top:24px">Fait le <span id="bail_date"></span> ‚Äî Signatures :</p>
      <div style="display:flex;gap:40px;margin-top:6px"><div>Le Bailleur</div><div>Le Locataire</div></div>
      <div id="sign_imgs_simple" style="display:flex;gap:60px;margin-top:18px">
        <div style="text-align:center"><img id="sig_b_simple" style="max-width:280px;max-height:120px;object-fit:contain"></div>
        <div style="text-align:center"><img id="sig_l_simple" style="max-width:280px;max-height:120px;object-fit:contain"></div>
      </div>
    </div>

    <!-- Impression bail "complet" -->
    <div id="bail_full_print" class="print-block" style="background:#fff;color:#000;padding:20px">
      <div id="bail_full_content" style="white-space:pre-wrap"></div>
      <div id="sign_imgs_full" style="display:flex;gap:60px;margin-top:18px">
        <div style="text-align:center"><div style="margin-bottom:6px">Signature du Bailleur</div><img id="sig_b_full" style="max-width:280px;max-height:120px;object-fit:contain"></div>
        <div style="text-align:center"><div style="margin-bottom:6px">Signature du Locataire</div><img id="sig_l_full" style="max-width:280px;max-height:120px;object-fit:contain"></div>
      </div>
    </div>

    <!-- IRL & Assurance (calculs + courriers) -->
    <div class="card" style="margin-top:16px">
      <h3>IRL ‚Äî Indexation automatique</h3>
      <div class="row">
        <div class="col-4"><label>Date anniversaire</label><input id="irl_anniv" type="date"></div>
        <div class="col-4"><label>Trimestre (auto)</label><input id="irl_trim" readonly></div>
        <div class="col-4"><label>IRL ancien</label><input id="irl_ref" type="number" step="0.01"></div>
        <div class="col-4"><label>IRL nouveau</label><input id="irl_new" type="number" step="0.01"></div>
        <div class="col-4"><label>Loyer de base (‚Ç¨)</label><input id="irl_base" type="number" step="0.01"></div>
        <div class="col-12">
          <button class="btn" id="irl_detect">Calculer</button>
          <button class="btn" id="irl_letter">üì© Courrier IRL</button>
        </div>
        <div class="col-12"><pre id="irl_calc_out" class="note" style="white-space:pre-wrap;background:#0b0e15;border:1px solid #232937;padding:10px;border-radius:10px"></pre></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Assurance habitation ‚Äî rappel + courrier</h3>
      <div class="row">
        <div class="col-4"><label>Date attestation</label><input id="assu_date" type="date"></div>
        <div class="col-4"><label>Rappel (jours avant)</label><input id="assu_rappel_j" type="number" value="15"></div>
        <div class="col-4" style="display:flex;align-items:end"><button class="btn" id="assu_letter">üì© Courrier attestation</button></div>
      </div>
    </div>
  </section>
  <!-- EDL AVANC√â -->
  <section id="edl" class="card hidden">
    <h2>üõ†Ô∏è EDL avanc√© ‚Äî pi√®ces, √©l√©ments, photos, relev√©s & inventaire</h2>

    <div class="row">
      <div class="col-6"><label>Bien (adresse)</label><input id="e_bien" placeholder="Ex: 4 rue Quiquerue, Ault"></div>
      <div class="col-3"><label>Ajouter une pi√®ce (s√©lection)</label><select id="e_piece_select"></select></div>
      <div class="col-3" style="display:flex;align-items:end;gap:8px"><button class="btn accent" id="e_add_piece">Ajouter la pi√®ce</button></div>
      <div class="col-6"><label>Nouvelle pi√®ce (personnalis√©e)</label><input id="e_piece_custom" placeholder="Ex: Chambre 2, Cellier, Terrasse‚Ä¶"></div>
      <div class="col-6" style="display:flex;align-items:end;gap:8px"><button class="btn" id="e_add_piece_custom">Ajouter pi√®ce personnalis√©e</button></div>
    </div>

    <div id="e_pieces_container" class="grid" style="margin-top:10px"></div>

    <div class="card" style="margin-top:16px">
      <h3>üîå Relev√©s compteurs</h3>
      <div class="row">
        <div class="col-3"><label>Type</label><select id="m_type"><option>Eau</option><option>√âlectricit√©</option><option>Gaz</option></select></div>
        <div class="col-3"><label>N¬∞ Compteur</label><input id="m_numero"></div>
        <div class="col-3"><label>Valeur</label><input id="m_valeur" type="number" step="0.01"></div>
        <div class="col-3"><label>Date</label><input id="m_date" type="date"></div>
        <div class="col-6"><label>Photo</label><input id="m_photo" type="file" accept="image/*" capture="environment"></div>
        <div class="col-6" style="display:flex;align-items:end"><button class="btn" id="m_add">Ajouter le relev√©</button></div>
      </div>
      <div id="m_list" class="grid" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>üßæ Inventaire mobilier & vaisselle</h3>
      <p class="note">Affich√© pour baux meubl√©s, mobilit√©, saisonniers, colocations.</p>
      <div class="row">
        <div class="col-4"><label>Item (s√©lection)</label><select id="inv_select"></select></div>
        <div class="col-2"><label>Qt√©</label><input id="inv_qty" type="number" value="1" min="1"></div>
        <div class="col-3"><label>√âtat</label><select id="inv_state"></select></div>
        <div class="col-3" style="display:flex;align-items:end"><button class="btn" id="inv_add">Ajouter</button></div>
        <div class="col-6"><label>Item personnalis√©</label><input id="inv_custom" placeholder="Ex: Cafeti√®re, Grille-pain‚Ä¶"></div>
        <div class="col-6" style="display:flex;align-items:end"><button class="btn" id="inv_add_custom">Ajouter item personnalis√©</button></div>
      </div>
      <div id="inv_list" class="grid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- SIGNATURES -->
  <section id="sign" class="card hidden">
    <h2>‚úçÔ∏è Signatures</h2>
    <p class="note">Dessinez votre signature ou importez une image, enregistrez-la, puis d√©finissez la signature par d√©faut Bailleur/Locataire. Elle sera ins√©r√©e automatiquement dans les baux imprim√©s.</p>

    <div class="row">
      <div class="col-12"><label>Nom de la signature</label><input id="s_label" placeholder="Ex: Bailleur ‚Äì DUPONT"></div>
      <div class="col-12">
        <canvas id="s_canvas" width="720" height="260" style="background:#fff;border-radius:12px;border:1px solid #c7c7c7;touch-action:none"></canvas>
        <div class="note">Astuce : maintenez clic / touchez pour dessiner.</div>
      </div>

      <div class="col-6">
        <label>Importer une image (PNG/JPG)</label>
        <input type="file" id="s_file" accept="image/*">
      </div>
      <div class="col-6" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
        <button class="btn" id="s_load_img">Placer l‚Äôimage</button>
        <button class="btn" id="s_clear">Effacer</button>
      </div>

      <div class="col-12" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn accent" id="s_save">Enregistrer</button>
        <button class="btn" id="s_export_png">Exporter PNG</button>
        <button class="btn" id="s_set_default_b">D√©finir Bailleur (d√©faut)</button>
        <button class="btn" id="s_set_default_l">D√©finir Locataire (d√©faut)</button>
      </div>

      <div class="col-12">
        <h3>Biblioth√®que de signatures</h3>
        <div id="s_gallery" class="row" style="gap:12px"></div>
        <p class="note">Cliquez une vignette pour la charger. üóë pour supprimer. ‚ÄúD√©faut‚Äù = ins√©rer automatiquement dans les baux.</p>
      </div>
    </div>
  </section>

  <!-- Modales Courriers -->
  <div class="modal" id="irlModal" aria-hidden="true">
    <div class="win">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Courrier r√©vision de loyer (IRL)</h3>
        <button class="btn" id="closeIrlModal">Fermer</button>
      </div>
      <textarea id="irl_letter_text" rows="14" style="width:100%;margin-top:10px"></textarea>
      <div style="margin-top:12px"><button class="btn accent" id="irl_letter_doc">T√©l√©charger (.doc)</button></div>
    </div>
  </div>

  <div class="modal" id="assuModal" aria-hidden="true">
    <div class="win">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Courrier ‚Äî Attestation d‚Äôassurance</h3>
        <button class="btn" id="closeAssuModal">Fermer</button>
      </div>
      <textarea id="assu_letter_text" rows="12" style="width:100%;margin-top:10px"></textarea>
      <div style="margin-top:12px"><button class="btn accent" id="assu_letter_doc">T√©l√©charger (.doc)</button></div>
    </div>
  </div>
  <!-- BIENS & RENTA -->
  <section id="biens" class="card hidden">
    <h2>üè† Biens & Rentabilit√©</h2>
    <p class="note">Tableau + graphiques (cashflow / r√©partition). Sauvegarde locale, exports CSV/JSON.</p>

    <div class="row">
      <div class="col-3"><label>Type</label><select id="p_type"><option>Location vide</option><option>Meubl√©e</option><option>Saisonnier</option><option>Mobilit√©</option><option>Colocation</option></select></div>
      <div class="col-5"><label>Adresse</label><input id="p_adresse" placeholder="N¬∞ rue, ville"></div>
      <div class="col-2"><label>Loyer HC (‚Ç¨/mois)</label><input id="p_loyer" type="number" step="0.01" value="650"></div>
      <div class="col-2"><label>Charges (‚Ç¨/mois)</label><input id="p_charges" type="number" step="0.01" value="40"></div>

      <div class="col-2"><label>TF (‚Ç¨/an)</label><input id="p_tf" type="number" step="0.01" value="800"></div>
      <div class="col-2"><label>Assurance (‚Ç¨/an)</label><input id="p_assu" type="number" step="0.01" value="120"></div>
      <div class="col-2"><label>Autres (‚Ç¨/an)</label><input id="p_autres" type="number" step="0.01" value="0"></div>
      <div class="col-2"><label>Vacance (mois/an)</label><input id="p_vac" type="number" step="0.1" value="1"></div>
      <div class="col-2"><label>Prix (‚Ç¨)</label><input id="p_prix" type="number" step="1" value="120000"></div>
      <div class="col-2"><label>Notaire (‚Ç¨)</label><input id="p_notaire" type="number" step="1" value="9000"></div>
      <div class="col-2" style="display:flex;align-items:end"><button class="btn accent" id="p_add">Ajouter / Mettre √† jour</button></div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table class="table" id="p_table">
        <thead>
          <tr>
            <th>#</th><th>Type</th><th>Adresse</th>
            <th>Loyer HC</th><th>Charges</th><th>TF</th><th>Assurance</th><th>Autres/an</th><th>Vacance (mois)</th>
            <th>Invest</th><th>Revenus/an</th><th>Charges/an</th><th>Cashflow/an</th><th>Rdt brut</th><th>Rdt net</th><th></th>
          </tr>
        </thead>
        <tbody></tbody><tfoot></tfoot>
      </table>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="col-6 card"><h3>üí∂ Cashflow par bien</h3><canvas id="chart_cash" height="200"></canvas></div>
      <div class="col-6 card"><h3>üìä R√©partition globale</h3><canvas id="chart_pie" height="200"></canvas></div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" id="p_export_csv">Exporter CSV</button>
      <button class="btn" id="p_export_json">Exporter JSON</button>
    </div>
  </section>
</main>

<footer class="container" style="text-align:center;color:#9aa3b2;margin:20px 0">¬© <span id="year"></span> MonBailZen</footer>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ========= Utils & Store ========= */
const store={set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}},reset:()=>{localStorage.clear();location.reload()}};
resetAll.onclick=()=>confirm("R√©initialiser toutes les donn√©es locales ?")&&store.reset();
year.textContent=new Date().getFullYear();

/* ========= Navigation onglets ========= */
document.querySelectorAll(".tabbtn").forEach(b=>b.addEventListener("click",()=>{
  document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  document.querySelectorAll("main>section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(b.dataset.tab).classList.remove("hidden");
  window.scrollTo({top:0,behavior:"smooth"});
}));

/* ========= BAUX ‚Äî chargement/sauvegarde ========= */
const B_KEYS=["b_bailleur","b_locataire","b_adresse","b_loyer","b_charges","b_depot","b_echeance","b_type","b_debut","b_duree","b_preavis","cl_caution_nom","cl_caution_montant","cl_caution_duree","cl_irl_a","cl_irl_n","cl_irl_date"];
const C_KEYS=["caution","irl","assurance","entretien","resolutoire","sousloc","preavis"];

function loadBail(){
  const b=store.get("mbz.bail",{}); B_KEYS.forEach(id=>{const el=document.getElementById(id); if(el&&b[id]!=null) el.value=b[id]});
  const c=store.get("mbz.clauses",{}); C_KEYS.forEach(k=>{const el=document.querySelector('.clause[data-key="'+k+'"]'); if(el&&c[k]!=null) el.checked=c[k]});
  (store.get("mbz.annexes",[])||[]).forEach(addAnnexeLi);
  const al=store.get("mbz.annexe_libre",""); if(annexe_libre && al) annexe_libre.value=al;
}
function saveBail(){
  const b={}; B_KEYS.forEach(id=>{const el=document.getElementById(id); if(el) b[id]=el.value}); store.set("mbz.bail",b);
  const c={}; C_KEYS.forEach(k=>{const el=document.querySelector('.clause[data-key="'+k+'"]'); if(el) c[k]=el.checked}); store.set("mbz.clauses",c);
  store.set("mbz.annexes",[...document.querySelectorAll("#annexe_list li")].map(li=>li.textContent));
  store.set("mbz.annexe_libre", annexe_libre?.value||"");
}
document.addEventListener("input",(e)=>{ if(e.target.closest("#baux")) saveBail(); });
document.addEventListener("DOMContentLoaded",()=>{ loadBail(); applyBailRules(false); refreshCautionPreview(); });

/* ========= BAUX ‚Äî r√®gles automatiques ========= */
const BAIL_RULES={
  "Location vide":{duree_mois:36,preavis_mois:3,note:"Bail vide : 3 ans, pr√©avis 3 mois (1 mois possible selon cas)."},
  "Meubl√©e":{duree_mois:12,preavis_mois:1,note:"Meubl√© : 1 an (9 mois √©tudiant), pr√©avis 1 mois."},
  "Saisonnier":{duree_mois:3,preavis_mois:0,note:"Saisonnier : court (‚â§3 mois), pas de reconduction."},
  "Mobilit√©":{duree_mois:6,preavis_mois:1,note:"Mobilit√© : 1 √† 10 mois, non renouvelable, pr√©avis 1 mois."}
};
function hasCustomDuration(){
  const el=b_duree; const typeSel=b_type?.value||"Location vide"; const v=parseInt(el?.value||0,10);
  if(!el||!v) return false;
  if(typeSel==="Saisonnier"||typeSel==="Mobilit√©"){const def=BAIL_RULES[typeSel].duree_mois; return v!==def;}
  return false;
}
function applyBailRules(fromUser=false){
  const typeSel=b_type?.value||"Location vide"; const rules=BAIL_RULES[typeSel]; if(!rules) return;
  if(b_duree){
    const shouldSetDefault = (typeSel==="Location vide"||typeSel==="Meubl√©e") ? (fromUser && document.activeElement===b_type) : !hasCustomDuration();
    if(shouldSetDefault && (!b_duree.value||fromUser)) b_duree.value=rules.duree_mois;
  }
  if(b_preavis && (!fromUser || document.activeElement===b_type)) b_preavis.value=rules.preavis_mois;
  if(b_rule_note) b_rule_note.textContent=rules.note;
  saveBail(); refreshCautionPreview();
}
b_type?.addEventListener("change",()=>applyBailRules(true));

/* ========= Annexes ========= */
function addAnnexeLi(name){
  const li=document.createElement("li"); li.textContent=name; li.style.cursor="pointer"; li.title="Cliquer pour supprimer";
  li.addEventListener("click",()=>{ li.remove(); saveBail(); });
  annexe_list.appendChild(li);
}
annexe_add.onclick=()=>{ if(annexe_nom.value.trim()){ addAnnexeLi(annexe_nom.value.trim()); annexe_nom.value=""; saveBail(); } };

/* ========= Baux ‚Äî g√©n√©ration de texte ========= */
function bailData(){
  const b=store.get("mbz.bail",{})||{};
  return {
    bailleur:b.b_bailleur||"‚Äî", locataire:b.b_locataire||"‚Äî", adresse:b.b_adresse||"‚Äî",
    loyer:parseFloat(b.b_loyer||0), charges:parseFloat(b.b_charges||0), depot:parseFloat(b.b_depot||0),
    echeance:parseInt(b.b_echeance||5,10),
    type:b.b_type||"Location vide", debut:b.b_debut||"‚Äî",
    duree:parseInt(b.b_duree||12,10), preavis:parseInt(b.b_preavis||1,10)
  };
}
function clauseText(){
  const c=store.get("mbz.clauses",{}); let out="";
  if(c.caution) out+="\n"+cautionClauseAuto();
  if(c.irl) out+="\nR√©vision IRL : base √ó (IRL_nouveau / IRL_ancien).";
  if(c.assurance) out+="\nAssurance : attestation annuelle obligatoire.";
  if(c.entretien) out+="\nR√©parations locatives (D√©cret 87-712).";
  if(c.resolutoire) out+="\nClause r√©solutoire (impay√©s, d√©faut d‚Äôassurance‚Ä¶).";
  if(c.sousloc) out+="\nSous-location interdite sans accord √©crit.";
  if(c.preavis) out+="\nPr√©avis & remise des cl√©s selon r√©gime.";
  const anns=store.get("mbz.annexes",[]); if(anns.length) out+=`\nAnnexes : ${anns.join(", ")}.`;
  const annLibre=store.get("mbz.annexe_libre",""); if(annLibre && annLibre.trim()) out+=`\n\nAnnexe libre :\n${annLibre.trim()}`;
  return out;
}
function bailTexte(d){
  const total=(d.loyer+d.charges).toFixed(2);
  return `BAIL D'HABITATION ‚Äî MonBailZen

Entre les soussign√©s :
- Bailleur : ${d.bailleur}
- Locataire : ${d.locataire}

Objet : ${d.type}
Logement : ${d.adresse}

Conditions financi√®res :
- Loyer mensuel hors charges : ${d.loyer.toFixed(2)} ‚Ç¨
- Provision sur charges : ${d.charges.toFixed(2)} ‚Ç¨
- Loyer mensuel total : ${total} ‚Ç¨
- D√©p√¥t de garantie : ${d.depot.toFixed(2)} ‚Ç¨
- √âch√©ance : le ${d.echeance} de chaque mois

Dur√©e : ${d.duree} mois √† compter du ${d.debut}
Pr√©avis locataire : ${d.preavis} mois

${clauseText()}
`;
}

/* ========= Caution solidaire (auto) ========= */
function reconductionTextByType(type){
  switch(type){
    case"Location vide":return"Dur√©e l√©gale 3 ans (pers. physique), reconduction tacite.";
    case"Meubl√©e":return"Dur√©e 1 an (9 mois √©tudiant), reconduction tacite.";
    case"Saisonnier":return"Dur√©e d√©termin√©e, pas de reconduction tacite.";
    case"Mobilit√©":return"1 √† 10 mois, non renouvelable."; default:return"Selon r√©gime."
  }
}
function cautionClauseAuto(){
  const b=store.get("mbz.bail",{})||{}; const type=b.b_type||"Location vide";
  const duree=parseInt(b.b_duree||12,10); const preavis=parseInt(b.b_preavis||1,10);
  const garant=cl_caution_nom?.value||"‚Äî"; const montant=cl_caution_montant?.value||"‚Äî";
  const dureeGarantie=cl_caution_duree?.value||duree||12; const reconduction=reconductionTextByType(type);
  return `Caution solidaire :
${garant} s'engage en qualit√© de caution solidaire du locataire, √† garantir le paiement de toutes sommes dues
(loyers, charges, int√©r√™ts, frais) dans la limite de ${montant} ‚Ç¨.

Dur√©e de l'engagement : ${dureeGarantie} mois (align√©e par d√©faut sur la dur√©e du bail de ${duree} mois).
Reconduction / renouvellement : ${reconduction}
Pr√©avis locataire : ${preavis} mois.`;
}
function refreshCautionPreview(){ const el=document.getElementById("clause_caution_preview"); if(el) el.textContent=cautionClauseAuto(); }
["b_type","b_duree","b_preavis","cl_caution_nom","cl_caution_montant","cl_caution_duree"].forEach(id=>document.getElementById(id)?.addEventListener("input",refreshCautionPreview));

/* ========= Actions bail (aper√ßu / doc / json / complet) ========= */
b_preview.onclick=()=>{ const t=bailTexte(bailData()); bail_content.textContent=t; bail_date.textContent=new Date().toLocaleDateString("fr-FR"); bail_print.classList.remove("hidden"); setTimeout(()=>{renderSignaturesInBail(); window.print();},40); };
b_doc.onclick=()=>{ const t=bailTexte(bailData()); const blob=new Blob([t],{type:"application/msword"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bail_monbailzen.doc"; a.click(); URL.revokeObjectURL(a.href); };
b_json.onclick=()=>{ const data={...bailData(),clauses:store.get("mbz.clauses",{}),annexes:store.get("mbz.annexes",[]),annexe_libre:store.get("mbz.annexe_libre","")}; const s=JSON.stringify(data,null,2); const blob=new Blob([s],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bail_monbailzen.json"; a.click(); URL.revokeObjectURL(a.href); };

/* ========= Bail complet (l√©gal) ========= */
function legalDurPreavisByType(type){
  switch(type){
    case"Location vide":return{dureeMois:36,preavisMois:3,renouvellement:"reconduction tacite triennale (pers. physique)"};
    case"Meubl√©e":return{dureeMois:12,preavisMois:1,renouvellement:"reconduction tacite annuelle (9 mois √©tudiant)"};
    case"Saisonnier":return{dureeMois:3,preavisMois:0,renouvellement:"pas de reconduction (contrat √† terme)"};
    case"Mobilit√©":return{dureeMois:6,preavisMois:1,renouvellement:"non renouvelable (1 √† 10 mois)"};
    default:return{dureeMois:12,preavisMois:1,renouvellement:"selon r√©gime"}
  }
}
function diagnosticsBloc(){return`Diagnostics : DPE, ERP, Plomb/Amiante si applicables, Surface habitable (loi Boutin), autres selon r√©glementation.`}
function clauseResolutoireBloc(){return`Clause r√©solutoire : r√©siliation de plein droit pour impay√©s/d√©faut d‚Äôassurance apr√®s commandement demeur√© infructueux (d√©lais l√©gaux).`}
function reparationsBloc(){return`R√©parations locatives ‚Äî D√©cret 87-712 : entretien courant et petites r√©parations √† la charge du locataire.`}
function edlBloc(){return`√âtat des lieux ‚Äî D√©cret 2016-382 : EDL d‚Äôentr√©e et de sortie contradictoires selon mentions obligatoires.`}
function assuranceBloc(){const assuDate=assu_date?.value||"‚Äî";return`Assurance habitation : attestation annuelle. Date de r√©f√©rence (rappel) : ${assuDate}.`}
function revisionIRLBbloc(){
  const ref=parseFloat(irl_ref?.value||0), neu=parseFloat(irl_new?.value||0), anniv=irl_anniv?.value||"date anniversaire";
  if(!ref||!neu) return`R√©vision IRL : r√©vision annuelle √† ${anniv} ‚Äî formule base √ó (IRL_nouveau / IRL_ancien).`;
  return`R√©vision IRL : ${anniv} ; IRL ${ref} ‚Üí ${neu}. Formule base √ó (IRL_nouveau / IRL_ancien).`;
}
function generateFullLeaseText(){
  const d=bailData(); const rules=legalDurPreavisByType(d.type); const total=(d.loyer+d.charges).toFixed(2);
  const annexes=(store.get("mbz.annexes",[])||[]); const annLibre=(store.get("mbz.annexe_libre","")||"").trim();
  const today=new Date().toLocaleDateString("fr-FR");
  const ENTETE=`BAIL D'HABITATION ‚Äî ${d.type}\nFait le ${today}\n\nEntre :\n- BAILLEUR : ${d.bailleur}\n- LOCATAIRE : ${d.locataire}`;
  const DESIGNATION=`D√©signation des locaux\nLogement : ${d.adresse}\nDestination : usage d‚Äôhabitation (sauf r√©gime sp√©cifique).`;
  const DUREE=`Dur√©e / renouvellement / pr√©avis\nDur√©e : ${d.duree} mois (r√©f. : ${rules.dureeMois} mois)\nRenouvellement/reconduction : ${rules.renouvellement}\nPr√©avis locataire : ${d.preavis||rules.preavisMois} mois`;
  const LOYER=`Loyer / charges / d√©p√¥t\n- Loyer HC : ${d.loyer.toFixed(2)} ‚Ç¨\n- Provision charges : ${d.charges.toFixed(2)} ‚Ç¨\n- Total mensuel : ${total} ‚Ç¨\n- D√©p√¥t de garantie : ${d.depot.toFixed(2)} ‚Ç¨\n- √âch√©ance : le ${d.echeance} de chaque mois`;
  const REVISION=revisionIRLBbloc(); const CAUTION=cautionClauseAuto(); const ASSU=assuranceBloc();
  const REPAR=reparationsBloc(); const EDL=edlBloc(); const CR=clauseResolutoireBloc(); const DIAG=diagnosticsBloc();
  const DIVERS=`Cession/sous-location : interdites sans accord √©crit.\nTravaux & acc√®s : selon textes.\nRestitution des cl√©s & DG : selon loi.\nRGPD & m√©diation : informations communiqu√©es.`;
  const ANNEXES=`Annexes :\n- Notice d‚Äôinformation\n- Diagnostics (cf. supra)\n- EDL d‚Äôentr√©e (+ sortie)\n${annexes.length? "- "+annexes.join("\n- "):""}\n${annLibre? "\nAnnexe libre :\n"+annLibre:""}`;
  const PIED=`Signatures\nLe Bailleur                               Le Locataire\n`;
  return [ENTETE,DESIGNATION,DUREE,LOYER,REVISION,CAUTION,ASSU,REPAR,EDL,CR,DIAG,DIVERS,ANNEXES,PIED].join("\n\n");
}
b_full.onclick=()=>{ const txt=generateFullLeaseText(); bail_full_content.textContent=txt; bail_full_print.classList.remove("hidden"); setTimeout(()=>{renderSignaturesInBail(); window.print();},40); };

/* ========= IRL ‚Äî calcul + rappel + courrier ========= */
function trimestreFromDate(dateStr){ try{const d=dateStr?new Date(dateStr):new Date(); const m=d.getMonth()+1; if(m<=3)return"T1"; if(m<=6)return"T2"; if(m<=9)return"T3"; return"T4";}catch(e){return"T1"} }
["irl_anniv","irl_ref","irl_new","irl_base"].forEach(id=>{ const el=document.getElementById(id); if(!el) return; const v=store.get("mbz."+id,""); if(v!==""&&v!=null) el.value=v; el.addEventListener("input",()=>store.set("mbz."+id,el.value)); });
function irlCompute(){
  const anniv=irl_anniv.value || (store.get("mbz.bail",{}).b_b_debut||"");
  const trim=trimestreFromDate(anniv); irl_trim.value=trim;
  const ref=parseFloat(irl_ref.value||0), neu=parseFloat(irl_new.value||0), base=parseFloat(irl_base.value||0);
  if(!ref||!neu||!base){ irl_calc_out.textContent="Renseignez IRL ancien, IRL nouveau et le loyer de base."; return null; }
  const indexe=base*(neu/ref), delta=indexe-base;
  irl_calc_out.textContent=`Trimestre : ${trim}\nAncien IRL : ${ref} | Nouvel IRL : ${neu}\nBase : ${base.toFixed(2)} ‚Ç¨ ‚Üí Nouveau loyer : ${indexe.toFixed(2)} ‚Ç¨ (Œî ${delta.toFixed(2)} ‚Ç¨)`;
  return {anniv,trim,ref,neu,base,indexe,delta};
}
irl_detect?.addEventListener("click",irlCompute);
function scheduleIrlAnnivCheck(){
  const key="mbz.irl.nextCheck"; const today=new Date(); today.setHours(0,0,0,0);
  const last=store.get(key,null); if(last && new Date(last).getTime()===today.getTime()) return;
  store.set(key,today.toISOString());
  const anniv=irl_anniv.value; if(!anniv) return;
  const a=new Date(anniv); a.setFullYear(today.getFullYear());
  if(a.getMonth()===today.getMonth() && a.getDate()===today.getDate()){
    const res=irlCompute(); if(res){ setTimeout(()=>openIrlLetter(res),100); alert("Rappel IRL : anniversaire aujourd‚Äôhui. Courrier pr√™t."); }
  }
}
setTimeout(scheduleIrlAnnivCheck,600);
function openIrlLetter(res){
  if(!res) res=irlCompute(); const d=bailData();
  const body=`Objet : R√©vision de loyer selon l‚ÄôIRL (${res.trim})
Madame, Monsieur,

Conform√©ment au bail du ${d.debut} et √† l‚ÄôIndice de R√©f√©rence des Loyers (${res.trim}), le loyer est r√©vis√© √† compter de ce jour.

Ancien loyer HC : ${res.base.toFixed(2)} ‚Ç¨
IRL nouveau / ancien : ${res.neu} / ${res.ref}
Nouveau loyer HC : ${res.indexe.toFixed(2)} ‚Ç¨ (variation : ${res.delta.toFixed(2)} ‚Ç¨)

Cordialement,
${d.bailleur}`;
  irl_letter_text.value=body; irlModal.style.display="flex"; irlModal.setAttribute("aria-hidden","false");
}
irl_letter?.addEventListener("click",()=>openIrlLetter(irlCompute()));
closeIrlModal?.addEventListener("click",()=>{ irlModal.style.display="none"; irlModal.setAttribute("aria-hidden","true"); });
irl_letter_doc?.addEventListener("click",()=>{ const s=irl_letter_text.value||""; const blob=new Blob([s],{type:"application/msword"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="courrier_revision_loyer_irl.doc"; a.click(); URL.revokeObjectURL(a.href); });

/* ========= Assurance ‚Äî rappel + courrier ========= */
["assu_date","assu_rappel_j"].forEach(id=>{ const el=document.getElementById(id); if(!el) return; const v=store.get("mbz."+id,""); if(v!==""&&v!=null) el.value=v; el.addEventListener("input",()=>store.set("mbz."+id,el.value)); });
function scheduleAssuCheck(){
  const key="mbz.assu.nextCheck"; const today=new Date(); today.setHours(0,0,0,0);
  const last=store.get(key,null); if(last && new Date(last).getTime()===today.getTime()) return;
  store.set(key,today.toISOString());
  const dStr=assu_date.value; const delai=parseInt(assu_rappel_j.value||15,10); if(!dStr||!delai) return;
  const d=new Date(dStr); const target=new Date(d); target.setFullYear(today.getFullYear());
  const diffDays=Math.ceil((target - today)/(1000*60*60*24));
  if(diffDays===delai){ openAssuLetter(); alert(`Rappel assurance : ${delai} jours avant l‚Äô√©ch√©ance. Courrier pr√™t.`); }
}
setTimeout(scheduleAssuCheck,800);
function openAssuLetter(){
  const d=bailData(); const dStr=assu_date.value||"‚Äî";
  const text=`Objet : Demande d‚Äôattestation d‚Äôassurance habitation

Madame, Monsieur,

Conform√©ment √† la loi, merci de nous transmettre votre attestation d‚Äôassurance habitation

  </section>
