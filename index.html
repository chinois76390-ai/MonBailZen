
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MonBailZen ‚Äî Baux ‚Ä¢ EDL ‚Ä¢ IRL ‚Ä¢ Signatures ‚Ä¢ Biens & Renta</title>
<meta name="description" content="Baux complets (vide, meubl√©, saisonnier, mobilit√©), EDL avanc√©s, IRL/assurance avec courriers automatiques, signatures manuscrites ou import, tableau de rentabilit√©.">
<style>
:root{--bg:#0a0b0f;--bg2:#0f1117;--card:#11141b;--muted:#c7c9d1;--text:#f4f5f7;--accent:#d4af37;--accent-weak:rgba(212,175,55,.16);--ring:0 0 0 3px rgba(212,175,55,.35);--shadow:0 8px 25px rgba(0,0,0,.45);--radius:16px}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.45}
.container{max-width:1180px;margin:0 auto;padding:22px}
.nav{position:sticky;top:0;z-index:50;background:rgba(10,11,15,.86);backdrop-filter:blur(10px);border-bottom:1px solid #232937}
.nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.badge{width:36px;height:28px;border-radius:8px;background:var(--accent);color:#211b05;display:grid;place-items:center;font-weight:900}
.menu{display:flex;flex-wrap:wrap;gap:10px}
.tabbtn,.btn{padding:10px 14px;border-radius:999px;border:1px solid #262c3a;background:#0e1219;color:var(--text);cursor:pointer}
.menu .tabbtn{border-radius:10px}
.tabbtn.active,.tabbtn:hover{background:var(--accent-weak);color:#1c1a11}
.btn.accent{background:var(--accent);color:#1d1604;border-color:transparent;font-weight:800}
.btn.ghost{background:transparent}
.btn:focus-visible{outline:none;box-shadow:var(--ring)}
.grid{display:grid;gap:18px}
.card{background:linear-gradient(180deg,var(--card),#0e1219);border:1px solid #232937;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
h2{margin:4px 0 8px}
label{display:block;margin:10px 0 6px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #262c3a;background:#0d1117;color:var(--text)}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-6{grid-column:span 6}.col-5{grid-column:span 5}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-12{grid-column:span 12}
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;background:#0d1117;border:1px solid #262c3a;border-radius:12px;overflow:hidden}
.table th{background:linear-gradient(180deg,#141926,#101521);color:#f6f6f6;text-align:left;padding:10px 12px;position:sticky;top:0}
.table td{padding:10px 12px;border-top:1px solid #1f2532}
.table tbody tr:nth-child(even){background:#0f1420}
.table tfoot td{font-weight:800;border-top:2px solid #31394b}
.badge-total{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--accent-weak);border:1px solid rgba(212,175,55,.4);color:#e9d79a}
.note{color:var(--muted);font-size:.93rem}
.hidden{display:none}
footer{text-align:center;color:var(--muted);margin:32px 0}
.hero{padding:24px;border-radius:18px;background:linear-gradient(180deg,#12151d,#0e1219);border:1px solid #232937;box-shadow:0 10px 28px rgba(0,0,0,.45);margin-bottom:16px}
.hero .kicker{display:inline-block;background:var(--accent-weak);border:1px solid rgba(212,175,55,.35);color:#e9d79a;border-radius:999px;padding:6px 12px;margin-bottom:10px;font-weight:800;letter-spacing:.2px}
.hero h2{font-size:2.1rem;margin:.2rem 0;color:#f7f7fa}
.hero p{max-width:78ch;color:#cfd3df}
@media (max-width:980px){.row{grid-template-columns:repeat(1,1fr)}}
@media print{body{background:#fff;color:#000}.nav,.no-print{display:none!important}.print-block{display:block}}
</style>
</head>
<body>
<nav class="nav">
  <div class="container nav-inner">
    <div class="brand"><div class="badge">MBZ</div>MonBailZen</div>
    <div class="menu no-print" id="menu">
      <button class="tabbtn active" data-tab="home">Accueil</button>
      <button class="tabbtn" data-tab="baux">Baux</button>
      <button class="tabbtn" data-tab="edl">EDL</button>
      <button class="tabbtn" data-tab="biens">Biens & Renta</button>
      <button class="tabbtn" data-tab="sign">Signatures</button>
    </div>
  </div>
</nav>

<main class="container grid">
  <!-- ========= ACCUEIL / HERO ========= -->
  <section id="home" class="card">
    <div class="hero">
      <span class="kicker">Bienvenue üëã</span>
      <h2>G√©n√©rez vos baux, r√©alisez des EDL, suivez vos biens & votre rentabilit√©.</h2>
      <p>IRL/assurance avec courriers automatiques, signatures manuscrites ou import, exports √©l√©gants. Th√®me <em>gold & dark</em> ‚ú®.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <button class="btn accent" onclick="go('baux')">Cr√©er un bail</button>
        <button class="btn" onclick="go('edl')">Faire un EDL</button>
        <button class="btn" onclick="go('biens')">Suivre ma renta</button>
      </div>
    </div>

    <h3>üí∞ Tarifs</h3>
    <table class="table">
      <thead><tr><th>Offre</th><th>Mensuel</th><th>Annuel</th><th>Inclus</th></tr></thead>
      <tbody>
        <tr><td>Essai 7 j</td><td>0 ‚Ç¨</td><td>‚Äî</td><td>1 bail + 1 EDL entr√©e</td></tr>
        <tr><td>Unitaire</td><td>7,90 ‚Ç¨</td><td>‚Äî</td><td>1 bail + 1 EDL entr√©e + cr√©dit sortie 0,5</td></tr>
        <tr><td>Starter</td><td>24 ‚Ç¨/mois</td><td>240 ‚Ç¨/an</td><td>3 baux + 3 EDL + IRL auto + export PDF/Word</td></tr>
        <tr><td>Pro</td><td>59 ‚Ç¨/mois</td><td>590 ‚Ç¨/an</td><td>Illimit√© + logo perso + exports compta</td></tr>
        <tr><td>Pause & sauvegarde</td><td>2 ‚Ç¨/mois</td><td>20 ‚Ç¨/an</td><td>Lecture seule + conservation</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ========= BAUX ========= -->
  <section id="baux" class="card hidden">
    <h2>üìÑ Bail (vide ‚Ä¢ meubl√© ‚Ä¢ saisonnier ‚Ä¢ mobilit√©)</h2>
    <div class="row">
      <div class="col-4"><label>Type de bail</label>
        <select id="b_type"><option>Location vide</option><option>Meubl√©e</option><option>Saisonnier</option><option>Mobilit√©</option></select>
      </div>
      <div class="col-4"><label>Dur√©e (mois)</label><input id="b_duree" type="number" value="36"></div>
      <div class="col-4"><label>Pr√©avis locataire (mois)</label><input id="b_preavis" type="number" value="3"></div>

      <div class="col-6"><label>Bailleur</label><input id="b_bailleur"></div>
      <div class="col-6"><label>Locataire</label><input id="b_locataire"></div>
      <div class="col-12"><label>Adresse du logement</label><input id="b_adresse"></div>

      <div class="col-3"><label>Loyer HC (‚Ç¨)</label><input id="b_loyer" type="number"></div>
      <div class="col-3"><label>Charges (‚Ç¨)</label><input id="b_charges" type="number"></div>
      <div class="col-3"><label>D√©p√¥t (‚Ç¨)</label><input id="b_depot" type="number"></div>
      <div class="col-3"><label>D√©but</label><input id="b_debut" type="date"></div>

      <div class="col-6"><label>Garant(s)</label><input id="b_garant" placeholder="Nom, adresse‚Ä¶"></div>
      <div class="col-6"><label>Clause solidaire (auto)</label><textarea id="b_clause" rows="3" readonly></textarea></div>
    </div>

    <h3>Annexes</h3>
    <div class="row">
      <div class="col-12"><textarea id="annexe_libre" rows="5" placeholder="Ajoutez ici vos annexes ou mentions (DPE, ERP, inventaire, EDL sign√©, conditions particuli√®res‚Ä¶)."></textarea></div>
    </div>

    <div class="row">
      <div class="col-6 card">
        <h3>üìà IRL ‚Äî indexation & courrier</h3>
        <div class="row">
          <div class="col-4"><label>Trimestre</label><select id="b_irl_trim"><option>T1</option><option>T2</option><option>T3</option><option>T4</option></select></div>
          <div class="col-4"><label>Ann√©e</label><input id="b_irl_year" type="number" value="2025"></div>
          <div class="col-4"><label>Anniversaire</label><input id="b_irl_date" type="date"></div>
          <div class="col-12"><button class="btn accent" id="b_calc_irl">üì© G√©n√©rer courrier IRL</button></div>
          <div class="col-12"><div id="b_irl_result" class="note"></div></div>
        </div>
      </div>

      <div class="col-6 card">
        <h3>üè† Assurance habitation</h3>
        <div class="row">
          <div class="col-6"><label>Date d‚Äôattestation</label><input id="b_assu_date" type="date"></div>
          <div class="col-6"><label>Statut</label><select id="b_assu_statut"><option>En attente</option><option>Re√ßue</option><option>Relance √† faire</option></select></div>
          <div class="col-12"><button class="btn accent" id="b_assu_courrier">üì© G√©n√©rer courrier assurance</button></div>
          <div class="col-12"><div id="b_assu_note" class="note"></div></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn accent" id="b_save">üíæ Enregistrer</button>
        <button class="btn" id="b_preview">üëÅÔ∏è Aper√ßu bail</button>
        <button class="btn" id="b_doc">‚¨áÔ∏è T√©l√©charger (.doc)</button>
        <button class="btn" onclick="openSign()">‚úçÔ∏è Signatures</button>
      </div>
      <div class="col-12 card hidden" id="b_preview_zone">
        <h3>üñ®Ô∏è Aper√ßu</h3><div id="bail_print"></div>
      </div>
    </div>
  </section>

  <!-- ========= EDL ========= -->
  <section id="edl" class="card hidden">
    <h2>üõ†Ô∏è EDL avanc√© ‚Äî pi√®ces, √©l√©ments, photos, relev√©s & inventaire</h2>
    <div class="row">
      <div class="col-6"><label>Bien</label><input id="e_bien" placeholder="Ex: 14 rue des Fleurs, Lille"></div>
      <div class="col-3"><label>Ajouter une pi√®ce</label><select id="e_piece_select"></select></div>
      <div class="col-3" style="display:flex;align-items:end"><button class="btn accent" id="e_add_piece">Ajouter</button></div>
      <div class="col-6"><label>Nouvelle pi√®ce</label><input id="e_piece_custom" placeholder="Ex: Chambre 2, Cellier‚Ä¶"></div>
      <div class="col-6" style="display:flex;align-items:end"><button class="btn" id="e_add_piece_custom">Ajouter</button></div>
    </div>
    <div id="e_pieces_container" class="grid" style="margin-top:10px"></div>

    <div class="card" style="margin-top:16px">
      <h3>üîå Relev√©s compteurs</h3>
      <div class="row">
        <div class="col-3"><label>Type</label><select id="m_type"><option>Eau</option><option>√âlectricit√©</option><option>Gaz</option></select></div>
        <div class="col-3"><label>N¬∞ compteur</label><input id="m_numero"></div>
        <div class="col-3"><label>Valeur</label><input id="m_valeur" type="number" step="0.01"></div>
        <div class="col-3"><label>Date</label><input id="m_date" type="date"></div>
        <div class="col-6"><label>Photo compteur</label><input id="m_photo" type="file" accept="image/*" capture="environment"></div>
        <div class="col-6" style="display:flex;align-items:end"><button class="btn" id="m_add">Ajouter relev√©</button></div>
      </div>
      <div id="m_list" class="grid" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>üßæ Inventaire mobilier (meubl√©/mobilit√©/saisonnier/coloc)</h3>
      <p class="note">Affich√© selon le type de bail.</p>
      <div class="row">
        <div class="col-4"><label>Item</label><select id="inv_select"></select></div>
        <div class="col-2"><label>Qt√©</label><input id="inv_qty" type="number" value="1" min="1"></div>
        <div class="col-3"><label>√âtat</label><select id="inv_state"></select></div>
        <div class="col-3" style="display:flex;align-items:end"><button class="btn" id="inv_add">Ajouter</button></div>
        <div class="col-6"><label>Item personnalis√©</label><input id="inv_custom" placeholder="Ex: Cafeti√®re, Grille-pain‚Ä¶"></div>
        <div class="col-6" style="display:flex;align-items:end"><button class="btn" id="inv_add_custom">Ajouter</button></div>
      </div>
      <div id="inv_list" class="grid" style="margin-top:10px"></div>
    </div>

    <div style="margin-top:16px"><button class="btn" id="e_export_csv">Exporter CSV</button><button class="btn" id="e_export_json">Exporter JSON</button></div>
  </section>

  <!-- ========= SIGNATURES ========= -->
  <section id="sign" class="card hidden">
    <h2>‚úçÔ∏è Signatures</h2>
    <p class="note">Dessinez ou importez vos signatures, d√©finissez Bailleur/Locataire par d√©faut et elles s‚Äôins√®rent dans l‚Äôaper√ßu du bail.</p>
    <div class="row">
      <div class="col-12"><label>Nom</label><input id="s_label" placeholder="Ex: Bailleur ‚Äì DUPONT"></div>
      <div class="col-12"><canvas id="s_canvas" width="720" height="260" style="background:#fff;border-radius:12px;border:1px solid #c7c7c7;touch-action:none"></canvas><div class="note">Maintenez clic/doigt pour dessiner.</div></div>
      <div class="col-6"><label>Importer une image</label><input type="file" id="s_file" accept="image/*"></div>
      <div class="col-6" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap"><button class="btn" id="s_load_img">Placer l‚Äôimage</button><button class="btn" id="s_clear">Effacer</button></div>
      <div class="col-12" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn accent" id="s_save">Enregistrer</button>
        <button class="btn" id="s_export_png">Exporter PNG</button>
        <button class="btn" id="s_set_default_b">D√©faut Bailleur</button>
        <button class="btn" id="s_set_default_l">D√©faut Locataire</button>
      </div>
      <div class="col-12"><h3>Biblioth√®que</h3><div id="s_gallery" class="row" style="gap:12px"></div></div>
    </div>
  </section>

  <!-- ========= BIENS & RENTA ========= -->
  <section id="biens" class="card hidden">
    <h2>üè† Biens & Rentabilit√©</h2>
    <p class="note">Tableau attractif + graphiques. Totaux, rendements brut/net, exports CSV/JSON.</p>
    <div class="row">
      <div class="col-3"><label>Type</label><select id="p_type"><option>Location vide</option><option>Meubl√©e</option><option>Saisonnier</option><option>Mobilit√©</option><option>Colocation</option></select></div>
      <div class="col-5"><label>Adresse</label><input id="p_adresse" placeholder="N¬∞ rue, ville"></div>
      <div class="col-2"><label>Loyer HC</label><input id="p_loyer" type="number" step="0.01" value="650"></div>
      <div class="col-2"><label>Charges</label><input id="p_charges" type="number" step="0.01" value="40"></div>
      <div class="col-2"><label>TF/an</label><input id="p_tf" type="number" step="0.01" value="800"></div>
      <div class="col-2"><label>Assurance/an</label><input id="p_assu" type="number" step="0.01" value="120"></div>
      <div class="col-2"><label>Autres/an</label><input id="p_autres" type="number" step="0.01" value="0"></div>
      <div class="col-2"><label>Vacance (mois)</label><input id="p_vac" type="number" step="0.1" value="1"></div>
      <div class="col-2"><label>Prix</label><input id="p_prix" type="number" value="120000"></div>
      <div class="col-2"><label>Notaire</label><input id="p_notaire" type="number" value="9000"></div>
      <div class="col-2" style="display:flex;align-items:end"><button class="btn accent" id="p_add">Ajouter / MAJ</button></div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table class="table" id="p_table">
        <thead><tr><th>#</th><th>Type</th><th>Adresse</th><th>Loyer HC</th><th>Charges</th><th>TF</th><th>Assurance</th><th>Autres</th><th>Vacance</th><th>Invest</th><th>Revenus/an</th><th>Charges/an</th><th>Cashflow/an</th><th>Rdt brut</th><th>Rdt net</th><th></th></tr></thead>
        <tbody></tbody><tfoot></tfoot>
      </table>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="col-6 card"><h3>üí∂ Cashflow annuel</h3><canvas id="chart_cash" height="200"></canvas></div>
      <div class="col-6 card"><h3>üìä R√©partition globale</h3><canvas id="chart_pie" height="200"></canvas></div>
    </div>

    <div style="margin-top:12px"><button class="btn" id="p_export_csv">Exporter CSV</button><button class="btn" id="p_export_json">Exporter JSON</button></div>
  </section>
</main>

<footer>¬© <span id="year"></span> MonBailZen ‚Äî Tous droits r√©serv√©s</footer>

<!-- Modale signatures (simple) -->
<div id="signModal" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px">
  <div style="background:#0f1219;border:1px solid #232937;border-radius:18px;max-width:820px;width:100%;padding:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <h3 style="margin:0">Signature</h3><button class="btn" onclick="closeSign()">Fermer</button>
    </div>
    <p class="note">Dessinez votre signature ou importez une image, puis enregistrez-la.</p>
    <div class="row">
      <div class="col-12"><label>Nom</label><input id="s_label_modal" placeholder="Ex: Bailleur ‚Äì DUPONT"></div>
      <div class="col-12"><canvas id="s_canvas_modal" width="720" height="260" style="background:#fff;border-radius:12px;border:1px solid #c7c7c7;touch-action:none"></canvas></div>
      <div class="col-6"><label>Image</label><input type="file" id="s_file_modal" accept="image/*"></div>
      <div class="col-6" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap"><button class="btn" id="s_load_img_modal">Placer l‚Äôimage</button><button class="btn" id="s_clear_modal">Effacer</button></div>
      <div class="col-12" style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn accent" id="s_save_modal">Enregistrer</button><button class="btn" id="s_def_b_modal">D√©faut Bailleur</button><button class="btn" id="s_def_l_modal">D√©faut Locataire</button></div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== NAVIGATION ===== */
function go(id){document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));const b=[...document.querySelectorAll(".tabbtn")].find(x=>x.dataset.tab===id);if(b)b.classList.add("active");document.querySelectorAll("main>section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden");window.scrollTo({top:0,behavior:"smooth"})}
document.querySelectorAll(".tabbtn").forEach(b=>b.addEventListener("click",()=>go(b.dataset.tab)));
year.textContent=new Date().getFullYear();

/* ===== STOCKAGE UTILS ===== */
const store={set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}}};

/* ===== BAUX ===== */
const BAIL_RULES={"Location vide":{duree:36,preavis:3},"Meubl√©e":{duree:12,preavis:1},"Saisonnier":{duree:3,preavis:0},"Mobilit√©":{duree:6,preavis:1}};
function applyBailRules(){const t=b_type.value,r=BAIL_RULES[t];if(!r)return;if(t==="Saisonnier"||t==="Mobilit√©"){if(!b_duree.value)b_duree.value=r.duree}else b_duree.value=r.duree;b_preavis.value=r.preavis;b_clause.value=b_garant.value.trim()?`Le garant, ${b_garant.value}, s‚Äôengage solidairement pour ${b_duree.value} mois (r√©gime ${t.toLowerCase()}).`:"Aucun garant d√©clar√©."}
["b_type","b_garant"].forEach(id=>document.getElementById(id).addEventListener("input",applyBailRules));applyBailRules();
function bailObj(){return{type:b_type.value,duree:+b_duree.value,preavis:+b_preavis.value,bailleur:b_bailleur.value,locataire:b_locataire.value,adresse:b_adresse.value,loyer:+b_loyer.value||0,charges:+b_charges.value||0,depot:+b_depot.value||0,debut:b_debut.value,garant:b_garant.value,annexe:annexe_libre.value}}
b_save.onclick=()=>{store.set("mbz.bail",bailObj());alert("Bail enregistr√©.")};
b_doc.onclick=()=>{const d=bailObj();const total=(d.loyer+d.charges).toFixed(2);const t=`BAIL ‚Äî ${d.type}\nBailleur: ${d.bailleur}\nLocataire: ${d.locataire}\nAdresse: ${d.adresse}\nLoyer HC: ${d.loyer} ‚Ç¨ ‚Äî Charges: ${d.charges} ‚Ç¨ ‚Äî Total: ${total} ‚Ç¨\nD√©p√¥t: ${d.depot} ‚Ç¨ ‚Äî D√©but: ${d.debut}\nDur√©e: ${d.duree} mois ‚Äî Pr√©avis: ${d.preavis} mois\nGarant: ${d.garant||"aucun"}\n\nClause: ${b_clause.value}\n\nAnnexes:\n${(d.annexe||"").trim()}`;const blob=new Blob([t],{type:"application/msword"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="bail_monbailzen.doc";a.click();URL.revokeObjectURL(a.href)};
b_preview.onclick=()=>{const d=bailObj();const total=(d.loyer+d.charges).toFixed(2);b_preview_zone.classList.remove("hidden");bail_print.innerHTML=`<p><strong>${d.type}</strong></p><p><strong>Bailleur :</strong> ${d.bailleur}<br><strong>Locataire :</strong> ${d.locataire}<br><strong>Adresse :</strong> ${d.adresse}</p><p><strong>Loyer HC :</strong> ${d.loyer} ‚Ç¨ ‚Äî <strong>Charges :</strong> ${d.charges} ‚Ç¨ ‚Äî <strong>Total :</strong> ${total} ‚Ç¨</p><p><strong>Dur√©e :</strong> ${d.duree} mois ‚Äî <strong>Pr√©avis :</strong> ${d.preavis} mois</p><p><strong>Garant :</strong> ${d.garant||"Aucun"}</p><p><em>Clause solidaire :</em> ${b_clause.value}</p><p><strong>Annexes :</strong><br>${(d.annexe||"‚Äî").replace(/\n/g,"<br>")}</p>`;renderSignaturesInPreview()};

/* IRL/Assurance */
async function fetchIRL(trim,year){const ref={T1:138.61,T2:140.59,T3:142.69,T4:144.25};return ref[trim]||140}
b_calc_irl.onclick=async()=>{const trim=b_irl_trim.value,year=+b_irl_year.value;const ref=await fetchIRL(trim,year-1),newv=await fetchIRL(trim,year);const pct=((newv-ref)/ref)*100;const nv=(+b_loyer.value||0)*(1+pct/100);b_irl_result.innerHTML=`IRL ${trim} ${year} : ${ref} ‚Üí ${newv} (+${pct.toFixed(2)}%)<br>Nouveau loyer HC : <strong>${nv.toFixed(2)} ‚Ç¨</strong>`};
b_assu_courrier.onclick=()=>{const date=b_assu_date.value||"____";b_assu_note.innerHTML=`<h4>Courrier assurance</h4><p>Merci de transmettre votre attestation d‚Äôassurance habitation √† jour avant le ${date}.</p>`};

/* ===== EDL ===== */
const EDL_DEFAULT_ROOMS=["Entr√©e","Salon / S√©jour","Cuisine","Chambre 1","Chambre 2","Salle de bain","WC","Couloir","Balcon / Terrasse","Cave / Cellier"];
const EDL_DEFAULT_ELEMENTS=["Murs","Plafond","Sol","Plinthes","Portes","Fen√™tres","Volets/Stores","√âlectricit√©","Prises","√âclairage","Chauffage/Radiateurs","EAU/Robinetterie","Sanitaires","√âlectrom√©nager","Rangements/Placards","Divers"];
const EDL_STATES=["Neuf","Tr√®s bon","Bon","Moyen","√Ä r√©nover","HS / Non fonctionnel"];
const INV_DEFAULT_ITEMS=["Lit 140","Lit 160","Table","Chaises x4","Canap√©","Armoire","Bureau","Plaques cuisson","Four","Micro-ondes","R√©frig√©rateur","Lave-linge","Assiettes x6","Verres x6","Couverts x6","Casseroles x3","Po√™le","Ustensiles divers"];
const ePieceSel=document.getElementById("e_piece_select"),invSel=document.getElementById("inv_select"),invStateSel=document.getElementById("inv_state");
[ePieceSel,invSel,invStateSel].forEach((sel,i)=>{if(!sel)return;const arr=[EDL_DEFAULT_ROOMS,INV_DEFAULT_ITEMS,EDL_STATES][i];sel.innerHTML=arr.map(v=>`<option>${v}</option>`).join("")});
function edlLoad(){return JSON.parse(localStorage.getItem("mbz.edl_v2")||"null")||{bien:"",rooms:[],meters:[],inventory:[]}}function edlSave(d){localStorage.setItem("mbz.edl_v2",JSON.stringify(d))}
let EDL=edlLoad();const eBien=document.getElementById("e_bien");if(eBien&&EDL.bien)eBien.value=EDL.bien;eBien?.addEventListener("input",()=>{EDL.bien=eBien.value;edlSave(EDL)});
const piecesContainer=document.getElementById("e_pieces_container");function fileToDataURL(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(f)})}
function renderRooms(){piecesContainer.innerHTML="";EDL.rooms.forEach((room,idx)=>{const card=document.createElement("div");card.className="card";card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap"><h3 style="margin:0">${room.name}</h3><div style="display:flex;gap:8px"><button class="btn" data-room-add-el="${idx}">+ √âl√©ment</button><button class="btn" data-room-photo="${idx}">+ Photos pi√®ce</button><button class="btn" data-room-del="${idx}">üóë</button></div></div><div class="row" id="room_photos_${idx}" style="margin-top:8px">${room.roomPhotos?.length?room.roomPhotos.map(src=>`<div class="col-3"><img src="${src}" style="width:100%;height:150px;object-fit:cover;border-radius:8px;border:1px solid #232937"/></div>`).join(""):`<div class="col-12 note">Aucune photo.</div>`}</div><div class="row" style="margin-top:10px"><div class="col-12"><table class="table"><thead><tr><th>√âl√©ment</th><th>√âtat</th><th>Anomalie</th><th>Photos anomalie</th><th></th></tr></thead><tbody id="room_tbl_${idx}">${room.elements.map((el,i)=>`<tr><td><input value="${el.name}" data-el-name="${idx}:${i}"></td><td><select data-el-state="${idx}:${i}">${EDL_STATES.map(s=>`<option ${s===el.state?'selected':''}>${s}</option>`).join("")}</select></td><td><input placeholder="Ex: rayures, fuite‚Ä¶" value="${el.anomalies?.[0]?.desc||''}" data-el-anom-desc="${idx}:${i}"></td><td><div style="display:flex;gap:6px;flex-wrap:wrap" id="anom_ph_${idx}_${i}">${(el.anomalies?.[0]?.photos||[]).map(src=>`<img src="${src}" style="width:72px;height:72px;object-fit:cover;border-radius:6px;border:1px solid #232937">`).join("")}</div><input type="file" accept="image/*" capture="environment" data-el-anom-photo="${idx}:${i}" multiple></td><td><button class="btn" data-el-del="${idx}:${i}">‚Äì</button></td></tr>`).join("")}</tbody></table></div></div>`;piecesContainer.appendChild(card)})}
function addRoom(name){if(!name||!name.trim())return;EDL.rooms.push({name:name.trim(),elements:EDL_DEFAULT_ELEMENTS.map(n=>({name:n,state:"Bon",photos:[],anomalies:[{desc:"",photos:[]}]})),roomPhotos:[]});edlSave(EDL);renderRooms()}
document.getElementById("e_add_piece").addEventListener("click",()=>addRoom(ePieceSel.value));document.getElementById("e_add_piece_custom").addEventListener("click",()=>{const v=document.getElementById("e_piece_custom").value;addRoom(v);if(v)document.getElementById("e_piece_custom").value=""});
piecesContainer.addEventListener("click",async(e)=>{const t=e.target;if(t.dataset.roomDel){const idx=+t.dataset.roomDel;if(confirm("Supprimer cette pi√®ce ?")){EDL.rooms.splice(idx,1);edlSave(EDL);renderRooms()}return}if(t.dataset.roomAddEl){const idx=+t.dataset.roomAddEl;const name=prompt("Nom de l'√©l√©ment ?");if(name){EDL.rooms[idx].elements.push({name,state:"Bon",photos:[],anomalies:[{desc:"",photos:[]}]} );edlSave(EDL);renderRooms()}return}if(t.dataset.roomPhoto){const idx=+t.dataset.roomPhoto;const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.multiple=true;inp.capture="environment";inp.onchange=async()=>{for(const f of [...inp.files]){const data=await fileToDataURL(f);EDL.rooms[idx].roomPhotos.push(data)}edlSave(EDL);renderRooms()};inp.click();return}});
piecesContainer.addEventListener("input",async(e)=>{const t=e.target;if(t.dataset.elName){const[ri,ei]=t.dataset.elName.split(":").map(Number);EDL.rooms[ri].elements[ei].name=t.value;edlSave(EDL)}if(t.dataset.elState){const[ri,ei]=t.dataset.elState.split(":").map(Number);EDL.rooms[ri].elements[ei].state=t.value;edlSave(EDL)}if(t.dataset.elAnomDesc){const[ri,ei]=t.dataset.elAnomDesc.split(":").map(Number);EDL.rooms[ri].elements[ei].anomalies[0].desc=t.value;edlSave(EDL)}if(t.dataset.elAnomPhoto){const[ri,ei]=t.dataset.elAnomPhoto.split(":").map(Number);for(const f of [...t.files]){const data=await fileToDataURL(f);EDL.rooms[ri].elements[ei].anomalies[0].photos.push(data)}edlSave(EDL);renderRooms()}});
piecesContainer.addEventListener("click",(e)=>{const t=e.target;if(t.dataset.elDel){const[ri,ei]=t.dataset.elDel.split(":").map(Number);EDL.rooms[ri].elements.splice(ei,1);edlSave(EDL);renderRooms()}});
const mList=document.getElementById("m_list");function renderMeters(){mList.innerHTML=(EDL.meters||[]).map((m,i)=>`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${m.type}</strong><button class="btn" data-m-del="${i}">üóë</button></div><div class="note">N¬∞ ${m.numero} ‚Äî Valeur ${m.valeur} ‚Äî Date ${m.date||"‚Äî"}</div>${m.photo?`<img src="${m.photo}" style="width:100%;max-height:180px;object-fit:contain;background:#fff;border:1px solid #232937;border-radius:8px;margin-top:6px">`:""}</div>`).join("")}
document.getElementById("m_add").addEventListener("click",async()=>{const type=m_type.value,numero=m_numero.value,valeur=m_valeur.value,date=m_date.value;const file=m_photo.files[0];let photo="";if(file)photo=await fileToDataURL(file);EDL.meters.push({type,numero,valeur,date,photo});edlSave(EDL);renderMeters();["m_numero","m_valeur","m_date","m_photo"].forEach(id=>{const el=document.getElementById(id);if(el)el.value=""})});mList.addEventListener("click",(e)=>{const t=e.target;if(t.dataset.mDel){const i=+t.dataset.mDel;EDL.meters.splice(i,1);edlSave(EDL);renderMeters()}});
const invList=document.getElementById("inv_list");function renderInventory(){invList.innerHTML=(EDL.inventory||[]).map((it,i)=>`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap"><strong>${it.name}</strong><div style="display:flex;gap:8px"><span class="badge-total">Qt√© ${it.qty}</span><span class="badge-total">${it.state}</span><button class="btn" data-inv-photo="${i}">+ Photo</button><button class="btn" data-inv-del="${i}">üóë</button></div></div>${it.photos?.length?`<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${it.photos.map(p=>`<img src="${p}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #232937">`).join("")}</div>`:""}</div>`).join("")}
function invAdd(name,qty,state){if(!name)return;EDL.inventory.push({name,qty:+qty||1,state:state||"Bon",photos:[]});edlSave(EDL);renderInventory()}
inv_add.onclick=()=>invAdd(inv_select.value,inv_qty.value,inv_state.value);inv_add_custom.onclick=()=>{const name=inv_custom.value;invAdd(name,inv_qty.value,inv_state.value);if(name)inv_custom.value=""}
invList.addEventListener("click",(e)=>{const t=e.target;if(t.dataset.invDel){const i=+t.dataset.invDel;EDL.inventory.splice(i,1);edlSave(EDL);renderInventory();return}if(t.dataset.invPhoto){const i=+t.dataset.invPhoto;const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.capture="environment";inp.onchange=async()=>{const f=inp.files[0];if(!f)return;const data=await fileToDataURL(f);EDL.inventory[i].photos=EDL.inventory[i].photos||[];EDL.inventory[i].photos.push(data);edlSave(EDL);renderInventory()};inp.click()}});
function updateInventoryVisibility(){const type=(document.getElementById("b_type")||{}).value||"Location vide";const card=invList.closest(".card");if(!card)return;const show=["Meubl√©e","Mobilit√©","Saisonnier","Colocation"].includes(type);card.style.display=show?"block":"none"}
document.getElementById("b_type")?.addEventListener("change",updateInventoryVisibility);
function edlToCSV(){let csv="section;champ;valeur\n";csv+=`bien;adresse;${EDL.bien||""}\n`;EDL.rooms.forEach((r,ri)=>{csv+=`piece_${ri+1};nom;${r.name}\n`;csv+=`piece_${ri+1};photos_piece;${(r.roomPhotos||[]).length}\n`;r.elements.forEach((el,ei)=>{csv+=`piece_${ri+1}_el_${ei+1};element;${el.name}\n`;csv+=`piece_${ri+1}_el_${ei+1};etat;${el.state}\n`;const an=el.anomalies?.[0]||{desc:"",photos:[]};csv+=`piece_${ri+1}_el_${ei+1};anomalie;${an.desc||""}\n`;csv+=`piece_${ri+1}_el_${ei+1};photos_anomalie;${(an.photos||[]).length}\n`})});(EDL.meters||[]).forEach((m,mi)=>{csv+=`compteur_${mi+1};type;${m.type}\n`;csv+=`compteur_${mi+1};numero;${m.numero}\n`;csv+=`compteur_${mi+1};valeur;${m.valeur}\n`;csv+=`compteur_${mi+1};date;${m.date}\n`});(EDL.inventory||[]).forEach((it,ii)=>{csv+=`inventaire_${ii+1};item;${it.name}\n`;csv+=`inventaire_${ii+1};quantite;${it.qty}\n`;csv+=`inventaire_${ii+1};etat;${it.state}\n`;csv+=`inventaire_${ii+1};photos;${(it.photos||[]).length}\n`});return csv}
e_export_csv.onclick=()=>{const blob=new Blob([edlToCSV()],{type:"text/csv;charset=utf-8"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="edl_avance.csv";a.click();URL.revokeObjectURL(a.href)}
e_export_json.onclick=()=>{const s=JSON.stringify(EDL,null,2);const blob=new Blob([s],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="edl_avance.json";a.click();URL.revokeObjectURL(a.href)}
renderRooms();renderMeters();renderInventory();updateInventoryVisibility();

/* ===== SIGNATURES ===== */
function openSign(){document.getElementById("signModal").style.display="flex";}
function closeSign(){document.getElementById("signModal").style.display="none";}
const sCanvas=document.getElementById("s_canvas_modal"),sCtx=sCanvas.getContext("2d");function clearCanvas(){sCtx.fillStyle="#fff";sCtx.fillRect(0,0,sCanvas.width,sCanvas.height)}clearCanvas();let drawing=false,lastX=0,lastY=0;function pos(e){const r=sCanvas.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;return{x,y}}
sCanvas.addEventListener("mousedown",e=>{drawing=true;({x:lastX,y:lastY}=pos(e))});window.addEventListener("mouseup",()=>drawing=false);sCanvas.addEventListener("mousemove",e=>{if(!drawing)return;const p=pos(e);sCtx.lineWidth=2.4;sCtx.lineJoin="round";sCtx.lineCap="round";sCtx.strokeStyle="#000";sCtx.beginPath();sCtx.moveTo(lastX,lastY);sCtx.lineTo(p.x,p.y);sCtx.stroke();lastX=p.x;lastY=p.y});sCanvas.addEventListener("touchstart",e=>{({x:lastX,y:lastY}=pos(e));drawing=true},{passive:false});sCanvas.addEventListener("touchmove",e=>{if(!drawing)return;e.preventDefault();const p=pos(e);sCtx.lineWidth=2.4;sCtx.strokeStyle="#000";sCtx.beginPath();sCtx.moveTo(lastX,lastY);sCtx.lineTo(p.x,p.y);sCtx.stroke();lastX=p.x;lastY=p.y},{passive:false});sCanvas.addEventListener("touchend",()=>drawing=false);
document.getElementById("s_clear_modal").onclick=clearCanvas;document.getElementById("s_load_img_modal").onclick=()=>{const f=document.getElementById("s_file_modal").files[0];if(!f){alert("S√©lectionne une image.");return}const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{clearCanvas();const s=Math.min(sCanvas.width/img.width,sCanvas.height/img.height),w=img.width*s,h=img.height*s,x=(sCanvas.width-w)/2,y=(sCanvas.height-h)/2;sCtx.drawImage(img,x,y,w,h)};img.src=e.target.result};r.readAsDataURL(f)};
function loadSignStore(){return JSON.parse(localStorage.getItem("mbz.signatures")||"[]")}function saveSignStore(a){localStorage.setItem("mbz.signatures",JSON.stringify(a))}function loadSignDefaults(){return JSON.parse(localStorage.getItem("mbz.sig.defaults")||"{}")}function saveSignDefaults(o){localStorage.setItem("mbz.sig.defaults",JSON.stringify(o))}
document.getElementById("s_save_modal").onclick=()=>{const label=(document.getElementById("s_label_modal").value||"Signature").trim();const data=sCanvas.toDataURL("image/png");const list=loadSignStore();list.unshift({label,data,ts:Date.now()});saveSignStore(list);refreshGallery();alert("Signature enregistr√©e.")};
document.getElementById("s_def_b_modal").onclick=()=>{const defs=loadSignDefaults();defs.bailleur=sCanvas.toDataURL("image/png");saveSignDefaults(defs);renderSignaturesInPreview();alert("D√©finie pour le Bailleur.")};
document.getElementById("s_def_l_modal").onclick=()=>{const defs=loadSignDefaults();defs.locataire=sCanvas.toDataURL("image/png");saveSignDefaults(defs);renderSignaturesInPreview();alert("D√©finie pour le Locataire.")};
function refreshGallery(){const wrap=document.getElementById("s_gallery");if(!wrap)return;const list=loadSignStore();wrap.innerHTML="";list.forEach((it,idx)=>{const c=document.createElement("div");c.className="card col-3";c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><strong>${it.label||"Signature"}</strong><button class="btn" data-del="${idx}">üóë</button></div><div style="display:grid;place-items:center;margin-top:8px"><img src="${it.data}" style="max-width:100%;max-height:120px;object-fit:contain;border:1px solid #232937;border-radius:8px;background:#fff"></div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px"><button class="btn" data-load="${idx}">Charger</button><button class="btn" data-defb="${idx}">D√©faut Bailleur</button><button class="btn" data-defl="${idx}">D√©faut Locataire</button></div>`;wrap.appendChild(c)});}
document.getElementById("s_gallery").addEventListener("click",(e)=>{const t=e.target;const list=loadSignStore();if(t.dataset.load){const it=list[+t.dataset.load];const img=new Image();img.onload=()=>{clearCanvas();const s=Math.min(sCanvas.width/img.width,sCanvas.height/img.height),w=img.width*s,h=img.height*s,x=(sCanvas.width-w)/2,y=(sCanvas.height-h)/2;sCtx.drawImage(img,x,y,w,h);document.getElementById("s_label_modal").value=it.label||""};img.src=it.data}if(t.dataset.del){const i=+t.dataset.del;if(confirm("Supprimer ?")){list.splice(i,1);saveSignStore(list);refreshGallery()}}if(t.dataset.defb||t.dataset.defl){const i=+(t.dataset.defb||t.dataset.defl);const it=list[i];const defs=loadSignDefaults();if(t.dataset.defb){defs.bailleur=it.data}else{defs.locataire=it.data}saveSignDefaults(defs);renderSignaturesInPreview()}});
refreshGallery();
function renderSignaturesInPreview(){const defs=loadSignDefaults();const zone=document.getElementById("bail_print");if(!zone)return;let sign=zone.querySelector(".sign-block");if(!sign){sign=document.createElement("div");sign.className="sign-block";sign.innerHTML=`<hr style="border:none;border-top:1px solid #ddd;margin:14px 0"><div style="display:flex;gap:40px;align-items:center"><div style="text-align:center"><div>Signature Bailleur</div><img id="sig_b_img" style="max-width:260px;max-height:110px;object-fit:contain"></div><div style="text-align:center"><div>Signature Locataire</div><img id="sig_l_img" style="max-width:260px;max-height:110px;object-fit:contain"></div></div>`;zone.appendChild(sign)}zone.querySelector("#sig_b_img").src=defs?.bailleur||"";zone.querySelector("#sig_l_img").src=defs?.locataire||""}

/* ===== BIENS & RENTA ===== */
const PKEY="mbz.biens";function pLoad(){return JSON.parse(localStorage.getItem(PKEY)||"[]")}function pSave(a){localStorage.setItem(PKEY,JSON.stringify(a))}let BIENS=pLoad();
function euro(n){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(+n||0)}function fmt(n){return(+n||0)}function percent(n){return(+(n||0)).toFixed(2)+" %"}
function pCompute(b){const loyerM=fmt(b.loyer),chargesM=fmt(b.charges),revenusAn=loyerM*12,vacCost=loyerM*Math.max(fmt(b.vac),0),chargesAn=(chargesM*12)+fmt(b.tf)+fmt(b.assu)+fmt(b.autres)+vacCost,cashflow=revenusAn-chargesAn,invest=fmt(b.prix)+fmt(b.notaire),rdtBrut=invest>0?(revenusAn/invest)*100:0,rdtNet=invest>0?((revenusAn-chargesAn)/invest)*100:0;return{revenusAn,chargesAn,cashflow,invest,rdtBrut,rdtNet,vacCost}}
function pRenderTable(){const tb=document.querySelector("#p_table tbody");tb.innerHTML="";let sumRev=0,sumChg=0,sumCF=0,sumInv=0;BIENS.forEach((b,i)=>{const c=pCompute(b);sumRev+=c.revenusAn;sumChg+=c.chargesAn;sumCF+=c.cashflow;sumInv+=c.invest;const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${b.type}</td><td>${b.adresse}</td><td>${euro(b.loyer)}</td><td>${euro(b.charges)}</td><td>${euro(b.tf)}</td><td>${euro(b.assu)}</td><td>${euro(b.autres)}</td><td>${b.vac||0}</td><td>${euro(c.invest)}</td><td><strong>${euro(c.revenusAn)}</strong></td><td>${euro(c.chargesAn)}</td><td><strong>${euro(c.cashflow)}</strong></td><td>${percent(c.rdtBrut)}</td><td>${percent(c.rdtNet)}</td><td><button class="btn" data-edit="${i}">‚úé</button><button class="btn" data-del="${i}">üóë</button></td>`;tb.appendChild(tr)});const tf=document.querySelector("#p_table tfoot");const rdtBrutG=sumInv>0?(sumRev/sumInv*100):0;const rdtNetG=sumInv>0?((sumRev-sumChg)/sumInv*100):0;tf.innerHTML=`<tr><td colspan="10" style="text-align:right;font-weight:800">Totaux</td><td><span class="badge-total">${euro(sumRev)}</span></td><td><span class="badge-total">${euro(sumChg)}</span></td><td><span class="badge-total">${euro(sumCF)}</span></td><td><span class="badge-total">${percent(rdtBrutG)}</span></td><td><span class="badge-total">${percent(rdtNetG)}</span></td><td></td></tr>`}
function pBindActions(){const tb=document.querySelector("#p_table tbody");tb.addEventListener("click",(e)=>{const t=e.target;if(t.dataset.del){const i=+t.dataset.del;if(confirm("Supprimer ce bien ?")){BIENS.splice(i,1);pSave(BIENS);pRenderTable();pRenderCharts()}}if(t.dataset.edit){const i=+t.dataset.edit;const b=BIENS[i];if(!b)return;p_type.value=b.type;p_adresse.value=b.adresse;p_loyer.value=b.loyer;p_charges.value=b.charges;p_tf.value=b.tf;p_assu.value=b.assu;p_autres.value=b.autres;p_vac.value=b.vac;p_prix.value=b.prix;p_notaire.value=b.notaire;p_add.dataset.editing=i;p_add.textContent="Mettre √† jour";window.scrollTo({top:document.getElementById("biens").offsetTop-20,behavior:"smooth"})}})}
function pAddOrUpdate(){const payload={type:p_type.value,adresse:p_adresse.value.trim(),loyer:+p_loyer.value||0,charges:+p_charges.value||0,tf:+p_tf.value||0,assu:+p_assu.value||0,autres:+p_autres.value||0,vac:+p_vac.value||0,prix:+p_prix.value||0,notaire:+p_notaire.value||0};if(!payload.adresse){alert("Adresse requise");return}if(p_add.dataset.editing){BIENS[+p_add.dataset.editing]=payload;delete p_add.dataset.editing;p_add.textContent="Ajouter / MAJ"}else{BIENS.push(payload)}pSave(BIENS);pRenderTable();pRenderCharts();p_adresse.value=""}
p_add.addEventListener("click",pAddOrUpdate);
let chartCash=null,chartPie=null;function pRenderCharts(){const labels=BIENS.map((b,i)=>(i+1)+". "+(b.adresse||"").split(",")[0]);const cash=BIENS.map(b=>pCompute(b).cashflow);const totalRev=BIENS.reduce((a,b)=>a+pCompute(b).revenusAn,0);const totalChg=BIENS.reduce((a,b)=>a+pCompute(b).chargesAn,0);const ctx1=document.getElementById("chart_cash").getContext("2d");if(chartCash)chartCash.destroy();chartCash=new Chart(ctx1,{type:"bar",data:{labels,datasets:[{label:"Cashflow annuel (‚Ç¨)",data:cash}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});const ctx2=document.getElementById("chart_pie").getContext("2d");if(chartPie)chartPie.destroy();chartPie=new Chart(ctx2,{type:"pie",data:{labels:["Revenus/an","Charges/an"],datasets:[{data:[totalRev,totalChg]}]},options:{responsive:true}})}
p_export_csv.onclick=()=>{let csv="type;adresse;loyer_m;charges_m;tf_a;assu_a;autres_a;vac_mois;prix;notaire;revenus_a;charges_a;cashflow_a;rdt_brut;rdt_net\n";BIENS.forEach(b=>{const c=pCompute(b);csv+=[b.type,b.adresse,b.loyer,b.charges,b.tf,b.assu,b.autres,b.vac,b.prix,b.notaire,c.revenusAn,c.chargesAn,c.cashflow,c.rdtBrut.toFixed(2),c.rdtNet.toFixed(2)].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(";")+"\n"});const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="biens_renta.csv";a.click();URL.revokeObjectURL(a.href)}
p_export_json.onclick=()=>{const s=JSON.stringify({biens:BIENS,calc:BIENS.map(b=>({adresse:b.adresse,...pCompute(b)}))},null,2);const blob=new Blob([s],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="biens_renta.json";a.click();URL.revokeObjectURL(a.href)}
pRenderTable();pBindActions();pRenderCharts();
</script>
</body>
</html>
