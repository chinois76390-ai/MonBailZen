<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MonBailZen — version finale (démo autonome)</title>
<meta name="description" content="Baux, EDL multi-pièces avec photos, signature eIDAS (démo), IRL, compta, exports CSV/PDF — démo 100% front-end.">
<style>
:root{
  --bg:#0e1014; --panel:#151b22; --soft:#10131b; --text:#e7edf4; --muted:#a8b3c2;
  --gold:#f0b84c; --gold2:#f3d98a; --line:#243044; --accent:#6ea8fe; --ok:#57d38b; --warn:#ffcc66;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg),#0b0f15);color:var(--text);font:15px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.top{position:sticky;top:0;background:#0e1014cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:100}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:42px;height:42px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;font-weight:900}
.title{font-size:18px}
.chip{background:#20283a;color:#cfe0ff;padding:3px 8px;border-radius:8px;font-size:12px;margin-left:6px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.tab{cursor:pointer;background:#1a2130;color:var(--text);border:1px solid var(--line);padding:9px 12px;border-radius:999px}
.tab.active{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border-color:transparent;font-weight:800}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
.btn:hover{border-color:#3b4f6b}
.btn.gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border:0;font-weight:800}
.btn.small{padding:8px 12px;font-size:13px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:16px;margin-top:14px}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr} .cols-3{grid-template-columns:1fr}
@media(min-width:960px){.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:repeat(3,1fr)}}
.kpis{display:grid;gap:10px} @media(min-width:900px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:#111827;border:1px solid #223046;border-radius:14px;padding:12px}
.kpi .big{font-weight:800}
label{display:block;font-size:12px;color:#9fb1c3;margin:6px 0 4px}
input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #273246;background:#0b0f15;color:var(--text)}
textarea{min-height:90px}
.muted{color:var(--muted)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.hidden{display:none}
.hr{height:1px;background:#1f2a3a;margin:12px 0}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{padding:10px;border-bottom:1px solid #223046;text-align:left}
.notice{border:1px dashed #33476b;background:#0f1626;border-radius:10px;padding:10px}
.pill{display:inline-block;background:#0f1626;border:1px solid #223046;border-radius:999px;padding:6px 10px;font-size:12px}
.footer{margin:24px 0;color:var(--muted);font-size:12px;text-align:center}

/* Signature modal */
.modal{position:fixed;inset:0;display:grid;place-items:center;background:#0008;z-index:1000}
.modal .box{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;width:min(660px,95vw)}
#sig_pad{background:#fff;border-radius:8px;border:1px solid #ccc}
.noscroll{overflow:hidden}

/* Image previews */
.preview{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.preview img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #223046}

/* badges tarifs */
.price{background:#101624;border:1px solid #223046;border-radius:16px;padding:16px;text-align:center}
.price .amount{font-size:24px;margin-top:8px}
.price.highlight{border-color:var(--gold)}
</style>
</head>
<body>
<header class="top">
  <div class="wrap">
    <div class="brand">
      <div class="logo">MBZ</div>
      <div class="title">MonBailZen <span class="chip">final</span></div>
    </div>
    <nav class="tabs" id="top-tabs">
      <button class="tab active" data-tab="home">Accueil</button>
      <button class="tab" data-tab="features">Fonctionnalités</button>
      <button class="tab" data-tab="pricing">Tarifs</button>
      <button class="tab" data-tab="faq">FAQ</button>
      <button class="tab" data-tab="contact">Contact</button>
      <button class="tab gold" data-tab="app">Essayer la démo</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Accueil -->
  <section class="card tab-pane" id="home">
    <div class="grid cols-2">
      <div>
        <h1>Gérez vos locations en toute sérénité.</h1>
        <p class="muted">Baux guidés, EDL multi-pièces + photos, signature eIDAS (démo), IRL, comptabilité mensuelle & annuelle, exports PDF/CSV (démo).</p>
        <div class="kpis">
          <div class="kpi"><div class="big">−70%</div><div class="muted">Temps de gestion</div></div>
          <div class="kpi"><div class="big">ALUR • ELAN • eIDAS</div><div class="muted">Conformité</div></div>
          <div class="kpi"><div class="big">PDF & CSV</div><div class="muted">Exports</div></div>
          <div class="kpi"><div class="big">4,8/5</div><div class="muted">Satisfaction estimée</div></div>
        </div>
        <div class="flex" style="margin-top:10px">
          <button class="btn gold" data-jump="app">Démarrer la démo</button>
          <a class="btn" data-jump="features">Voir les fonctionnalités</a>
        </div>
      </div>
      <div class="notice">
        <b>Pourquoi MonBailZen ?</b>
        <ul>
          <li>Formulaires guidés bailleur / locataire / garant</li>
          <li>EDL multi-pièces (murs/sols/plafonds/menuiseries/radiateurs/appareils)</li>
          <li>Photos état initial & anomalies, signature (démo)</li>
          <li>IRL & rappels loyers, comptabilité auto (démo)</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Fonctionnalités -->
  <section class="card tab-pane hidden" id="features">
    <h2>Fonctionnalités clés</h2>
    <ul>
      <li>Baux : vide, meublé, colocation, mobilité. Clauses particulières & annexes.</li>
      <li>État des lieux : entrée/sortie, pièces illimitées, photos, notes, signature (démo).</li>
      <li>IRL : indexation automatique (taux saisi), ajustement du loyer.</li>
      <li>Comptabilité : entrées libres, total auto, export CSV & PDF (aperçu imprimable).</li>
      <li>Stockage : données locales (démo). Production : base + signature qualifiée eIDAS.</li>
    </ul>
    <div class="hr"></div>
    <span class="pill">Démo autonome (sans serveur) — parfaite pour tester.</span>
  </section>

  <!-- Tarifs -->
  <section class="card tab-pane hidden" id="pricing">
    <div class="grid cols-3">
      <div class="price">
        <h3>À la carte</h3>
        <p>1 bail complet</p>
        <div class="amount">9,90 €</div>
      </div>
      <div class="price">
        <h3>Starter</h3>
        <p>3 baux + 3 EDL • compta mensuelle</p>
        <div class="amount">29,90 €</div>
      </div>
      <div class="price highlight">
        <h3>Pro illimité</h3>
        <p>Baux & EDL illimités • entête personnalisée • clauses pro</p>
        <div class="amount">79,90 €/mois</div>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section class="card tab-pane hidden" id="faq">
    <h2>FAQ</h2>
    <p><b>Documents opposables ?</b> La démo fournit des aperçus. En production : modèles ALUR/ELAN + signature eIDAS + horodatage.</p>
    <p><b>Données ?</b> Dans la démo, stockage local (navigateur). En production : base sécurisée, sauvegardes, pièces jointes.</p>
  </section>

  <!-- Contact -->
  <section class="card tab-pane hidden" id="contact">
    <h2>Contact</h2>
    <p class="mono">MBZ — MonBailZen • Auto-entreprise (à compléter)<br>Siège : (à compléter) • SIREN : (à compléter)<br>Hébergeur : Vercel Inc.</p>
    <p class="muted">contact@monbailzen.app (démo)</p>
  </section>

  <!-- APPLICATION -->
  <section class="card tab-pane hidden" id="app">
    <h2>Application — Démo</h2>
    <div class="grid cols-2">
      <!-- BAIL -->
      <div class="card">
        <h3>Créer un bail</h3>
        <div class="grid cols-2">
          <div>
            <label>Type de bail</label>
            <select id="b_type"><option>Vide</option><option selected>Meublé</option><option>Colocation</option><option>Mobilité</option></select>
            <label>Adresse</label><input id="b_addr" placeholder="N°, rue, CP, ville">
            <label>Loyer HC (€)</label><input id="b_rent" type="number" value="650">
            <label>Charges (€)</label><input id="b_chg" type="number" value="50">
            <label>Date d’effet</label><input id="b_date" type="date">
          </div>
          <div>
            <label>Bailleur</label><input id="b_landlord" placeholder="Nom Prénom / Société">
            <label>Locataire</label><input id="b_tenant" placeholder="Nom Prénom">
            <label>Garant (optionnel)</label><input id="b_guarantor" placeholder="Nom Prénom">
            <label>Mode de paiement</label><select id="b_pay"><option>Virement</option><option>Prélèvement</option><option>Chèque</option><option>Espèces</option></select>
            <div class="grid cols-2">
              <div><label>Terme</label><select id="b_term"><option>Échu</option><option>À échoir</option></select></div>
              <div><label>Jour (1–28)</label><input id="b_payday" type="number" min="1" max="28" value="5"></div>
            </div>
          </div>
        </div>
        <label>Clauses particulières (annexe)</label><textarea id="b_clauses" placeholder="Ex. Murs non percés ; filtre hotte à changer 1x/an ; …"></textarea>
        <div class="grid cols-3">
          <div><label>IRL (%)</label><input id="b_irl" type="number" step="0.01" value="3.25"></div>
          <div class="flex"><button class="btn small" id="b_apply_irl">Appliquer IRL</button></div>
          <div class="flex"><button class="btn small" id="b_save">Sauvegarder</button></div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn gold" id="b_generate">Générer (démo)</button>
          <button class="btn" id="b_pdf">PDF (aperçu)</button>
        </div>
      </div>

      <!-- EDL -->
      <div class="card">
        <h3>État des lieux</h3>
        <div class="grid cols-2">
          <div>
            <label>Type</label><select id="e_type"><option>Entrée</option><option>Sortie</option></select>
          </div>
          <div class="flex" style="align-items:flex-end">
            <button class="btn small" id="add_room">+ Ajouter une pièce</button>
          </div>
        </div>
        <div id="rooms"></div>
        <div class="grid cols-2">
          <div>
            <label>Photos état initial</label>
            <input id="e_photos" type="file" accept="image/*" multiple>
            <div id="prev_ok" class="preview"></div>
          </div>
          <div>
            <label>Photos anomalies</label>
            <input id="e_issues" type="file" accept="image/*" multiple>
            <div id="prev_ko" class="preview"></div>
          </div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn" id="e_pdf">PDF (aperçu)</button>
          <button class="btn gold" id="e_sign">Signature (démo)</button>
        </div>
      </div>
    </div>

    <!-- COMPTA -->
    <div class="card">
      <h3>Comptabilité (démo)</h3>
      <div class="grid cols-3">
        <div><label>Montant (€)</label><input id="acc_amt" type="number" value="700"></div>
        <div><label>Date</label><input id="acc_date" type="date"></div>
        <div><label>Note</label><input id="acc_note" placeholder="Loyer Janvier"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn small" id="acc_add">Ajouter</button>
        <button class="btn small" id="acc_csv">Export CSV</button>
        <button class="btn small" id="acc_pdf">Export PDF (aperçu)</button>
      </div>
      <table id="acc_table" class="table"></table>
    </div>
  </section>
</main>

<footer class="footer">© 2025 MonBailZen — Démo front-end autonome. eIDAS simulée. Données locales.</footer>

<!-- Signature modal (n’APPARAÎT JAMAIS toute seule) -->
<div id="sig_modal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="box">
    <div class="flex" style="justify-content:space-between">
      <h3 style="margin:0">Signature (démo)</h3>
      <button id="sig_close" class="btn small">Fermer</button>
    </div>
    <div style="margin:10px 0">
      <canvas id="sig_pad" width="560" height="180"></canvas>
    </div>
    <div class="flex">
      <button id="sig_clear" class="btn small">Effacer</button>
      <button id="sig_save" class="btn gold small">Enregistrer</button>
    </div>
  </div>
</div>

<script>
(() => {
  const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const KEY='mbz_final_demo';
  const S={ lease:null, edl:{rooms:[],signature:null,type:'Entrée'}, acc:[] };

  // ---- Tabs
  const tabs=$$('#top-tabs .tab'); const panes=$$('.tab-pane');
  function showTab(name){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
    panes.forEach(p=>p.classList.toggle('hidden', p.id!==name));
    location.hash = name;
  }
  tabs.forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));
  $$('[data-jump]').forEach(el=>el.addEventListener('click',()=>showTab(el.dataset.jump)));
  showTab((location.hash||'#home').slice(1));

  // ---- Helpers
  const esc = s => (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const blob = (name, text, type='text/plain') => {
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type})); a.download=name; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  };

  // ---- Restore / Persist
  function persist(){ localStorage.setItem(KEY, JSON.stringify(S)); }
  function restore(){
    try{ const raw=localStorage.getItem(KEY); if(raw){ Object.assign(S, JSON.parse(raw)); } }catch{}
    if(S.lease){
      $('#b_type').value=S.lease.type||'Meublé';
      $('#b_addr').value=S.lease.addr||'';
      $('#b_rent').value=S.lease.rent||0;
      $('#b_chg').value=S.lease.charges||0;
      $('#b_date').value=S.lease.date||'';
      $('#b_landlord').value=S.lease.landlord||'';
      $('#b_tenant').value=S.lease.tenant||'';
      $('#b_guarantor').value=S.lease.guarantor||'';
      $('#b_pay').value=S.lease.pay||'Virement';
      $('#b_term').value=S.lease.term||'Échu';
      $('#b_payday').value=S.lease.payday||5;
      $('#b_clauses').value=S.lease.clauses||'';
      $('#b_irl').value=S.lease.irl||0;
    }
    if(S.edl?.rooms?.length){ S.edl.rooms.forEach(r=>addRoomPrefill(r)); }
    if(S.edl?.type) $('#e_type').value=S.edl.type;
    if(S.acc?.length) renderAcc();
  }
  restore();

  // ---- Lease
  $('#b_generate').onclick = ()=>{
    const L={
      type:$('#b_type').value, addr:$('#b_addr').value, rent:+$('#b_rent').value||0, charges:+$('#b_chg').value||0,
      date:$('#b_date').value, landlord:$('#b_landlord').value, tenant:$('#b_tenant').value, guarantor:$('#b_guarantor').value,
      pay:$('#b_pay').value, term:$('#b_term').value, payday:+$('#b_payday').value||5, clauses:$('#b_clauses').value,
      irl:+$('#b_irl').value||0, createdAt:new Date().toISOString()
    };
    S.lease=L; persist(); alert('Bail généré (démo).');
  };
  $('#b_pdf').onclick = ()=>{
    if(!S.lease){ alert('Créez d’abord un bail.'); return; }
    const L=S.lease, total=(L.rent+L.charges).toFixed(2);
    const w=window.open('','_blank');
    w.document.write(`<!doctype html><meta charset="utf-8"><title>Bail (démo)</title>
      <style>body{font:14px Arial;padding:24px} h1{font-size:20px}</style>
      <h1>Bail — ${esc(L.type)}</h1>
      <div><b>Bailleur:</b> ${esc(L.landlord||'')}</div>
      <div><b>Locataire:</b> ${esc(L.tenant||'')}</div>
      ${L.guarantor?`<div><b>Garant:</b> ${esc(L.guarantor)}</div>`:''}
      <div><b>Adresse:</b> ${esc(L.addr||'')}</div>
      <div><b>Date d’effet:</b> ${esc(L.date||'')}</div>
      <div><b>Loyer HC:</b> ${L.rent} € — <b>Charges:</b> ${L.charges} € — <b>Total:</b> ${total} €</div>
      <div><b>Paiement:</b> ${esc(L.pay)} — <b>Terme:</b> ${esc(L.term)} — <b>Jour:</b> ${L.payday}</div>
      <div><b>IRL de référence:</b> ${L.irl}%</div>
      ${L.clauses?`<h3>Annexe — Clauses particulières</h3><pre>${esc(L.clauses)}</pre>`:''}
      <hr><small>Démo — non opposable. Signature eIDAS simulée.</small>`);
    w.document.close();
  };
  $('#b_save').onclick = ()=>{ persist(); alert('Sauvegardé dans ce navigateur.'); };
  $('#b_apply_irl').onclick = ()=>{
    if(!S.lease){ alert('Créez d’abord un bail.'); return; }
    const rate=+$('#b_irl').value||0;
    S.lease.rent=Math.round(S.lease.rent*(1+rate/100)*100)/100;
    persist(); alert('IRL appliqué. Nouveau loyer HC: '+S.lease.rent+' €');
    $('#b_rent').value=S.lease.rent;
  };

  // ---- EDL
  function roomTemplate(r={}){
    const opt=(v,o)=>v===o?'selected':'';
    return `
    <div class="card edl-room">
      <div class="flex" style="justify-content:space-between"><b>Pièce</b><button class="btn small remove-room">Supprimer</button></div>
      <div class="grid cols-3">
        <div><label>Nom</label><input class="r-name" value="${esc(r.name||'Salon')}"></div>
        <div><label>Murs</label><select class="r-walls"><option ${opt(r.walls,'OK')}>OK</option><option ${opt(r.walls,'Micro-impacts')}>Micro-impacts</option><option ${opt(r.walls,'À repeindre')}>À repeindre</option><option ${opt(r.walls,'Réparations')}>Réparations</option></select></div>
        <div><label>Sols</label><select class="r-floor"><option ${opt(r.floor,'OK')}>OK</option><option ${opt(r.floor,'Rayures')}>Rayures</option><option ${opt(r.floor,'Taches')}>Taches</option><option ${opt(r.floor,'À remplacer')}>À remplacer</option></select></div>
        <div><label>Plafonds</label><select class="r-ceil"><option ${opt(r.ceil,'OK')}>OK</option><option ${opt(r.ceil,'Fissures')}>Fissures</option><option ${opt(r.ceil,'Jaunissement')}>Jaunissement</option></select></div>
        <div><label>Menuiseries</label><select class="r-wood"><option ${opt(r.wood,'OK')}>OK</option><option ${opt(r.wood,'Poignée à resserrer')}>Poignée à resserrer</option><option ${opt(r.wood,'Joint à changer')}>Joint à changer</option></select></div>
        <div><label>Radiateurs</label><select class="r-rad"><option ${opt(r.rad,'OK')}>OK</option><option ${opt(r.rad,'À purger')}>À purger</option><option ${opt(r.rad,'Remplacer robinet')}>Remplacer robinet</option></select></div>
        <div><label>Appareils</label><select class="r-app"><option ${opt(r.app,'OK')}>OK</option><option ${opt(r.app,'Nettoyage filtre')}>Nettoyage filtre</option><option ${opt(r.app,'Panne')}>Panne</option></select></div>
        <div style="grid-column:1/-1"><label>Observations</label><textarea class="r-notes" rows="2">${esc(r.notes||'')}</textarea></div>
      </div>
    </div>`;
  }
  function addRoom(){ $('#rooms').insertAdjacentHTML('beforeend', roomTemplate()); bindRoom($('#rooms .edl-room:last-child')); }
  function addRoomPrefill(r){ $('#rooms').insertAdjacentHTML('beforeend', roomTemplate(r)); bindRoom($('#rooms .edl-room:last-child')); }
  function bindRoom(box){ $('.remove-room',box).onclick=()=>box.remove(); }
  $('#add_room').onclick = addRoom;
  addRoom(); // par défaut une pièce vide

  // Photos globales
  function handleFiles(input, box){ box.innerHTML=''; [...input.files].forEach(f=>{ const rd=new FileReader(); rd.onload=e=>{ const i=new Image(); i.src=e.target.result; i.className='thumb'; i.style='width:90px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #223046;margin:4px'; box.appendChild(i); }; rd.readAsDataURL(f); }); }
  $('#e_photos').addEventListener('change', e=>handleFiles(e.target,$('#prev_ok')));
  $('#e_issues').addEventListener('change', e=>handleFiles(e.target,$('#prev_ko')));

  function collectEDL(){
    const rooms = $$('#rooms .edl-room').map(r=>({
      name:$('.r-name',r).value, walls:$('.r-walls',r).value, floor:$('.r-floor',r).value, ceil:$('.r-ceil',r).value,
      wood:$('.r-wood',r).value, rad:$('.r-rad',r).value, app:$('.r-app',r).value, notes:$('.r-notes',r).value
    }));
    S.edl={ type:$('#e_type').value, rooms, signature:S.edl.signature||null }; persist();
    return S.edl;
  }

  $('#e_pdf').onclick = ()=>{
    const edl=collectEDL();
    const sig = edl.signature ? `<h3>Signature (démo)</h3><img src="${edl.signature}" style="max-width:320px;border:1px solid #ccc">` : '';
    const items = edl.rooms.map(r=>`<div style="border:1px solid #ddd;border-radius:10px;padding:10px;margin:10px 0">
      <b>${esc(r.name)}</b><br>
      Murs: ${esc(r.walls)} • Sols: ${esc(r.floor)} • Plafonds: ${esc(r.ceil)} • Menuiseries: ${esc(r.wood)} • Radiateurs: ${esc(r.rad)} • Appareils: ${esc(r.app)}
      <div>Notes: ${esc(r.notes||'')}</div>
    </div>`).join('');
    const w=window.open('','_blank');
    w.document.write(`<!doctype html><meta charset="utf-8"><title>EDL (démo)</title>
      <style>body{font:14px Arial;padding:24px} h1{font-size:20px}</style>
      <h1>État des lieux — ${esc(edl.type)}</h1>${items}${sig}
      <hr><small>Démo — photos non intégrées pour limiter le poids. Signature simulée.</small>`);
    w.document.close();
  };

  // ---- Signature (NE S’OUVRE QUE SUR CLIC)
  const modal=$('#sig_modal'), pad=$('#sig_pad'), ctx=pad.getContext('2d'); ctx.lineWidth=2; ctx.lineCap='round';
  let draw=false, last=null;
  function pos(e){ const r=pad.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
  function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
  function openSig(){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); document.body.classList.add('noscroll'); }
  function closeSig(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('noscroll'); }
  $('#e_sign').onclick = openSig;
  $('#sig_close').onclick = closeSig;
  modal.addEventListener('click', e=>{ if(e.target===modal) closeSig(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape' && !modal.classList.contains('hidden')) closeSig(); });
  $('#sig_clear').onclick = ()=>ctx.clearRect(0,0,pad.width,pad.height);
  pad.addEventListener('mousedown', e=>{ draw=true; last=pos(e); });
  pad.addEventListener('mousemove', e=>{ if(!draw) return; const p=pos(e); line(last,p); last=p; });
  window.addEventListener('mouseup', ()=>{ draw=false; });
  pad.addEventListener('touchstart', e=>{ draw=true; last=pos(e); },{passive:true});
  pad.addEventListener('touchmove', e=>{ if(!draw) return; const p=pos(e); line(last,p); last=p; },{passive:true});
  pad.addEventListener('touchend', ()=>{ draw=false; });
  $('#sig_save').onclick = ()=>{ S.edl.signature = pad.toDataURL('image/png'); persist(); closeSig(); alert('Signature enregistrée (démo).'); };

  // ---- Comptabilité
  function renderAcc(){
    const t=$('#acc_table');
    const rows=S.acc.map(r=>`<tr><td>${r.date}</td><td>${r.amount.toFixed(2)} €</td><td>${esc(r.note||'')}</td></tr>`).join('');
    const total=S.acc.reduce((s,r)=>s+r.amount,0).toFixed(2);
    t.innerHTML=`<tr><th>Date</th><th>Montant</th><th>Note</th></tr>${rows}<tr><th>Total</th><th>${total} €</th><th></th></tr>`;
  }
  $('#acc_add').onclick = ()=>{
    const row={ amount:+$('#acc_amt').value||0, date:$('#acc_date').value||new Date().toISOString().slice(0,10), note:$('#acc_note').value||'' };
    S.acc.push(row); persist(); renderAcc();
  };
  $('#acc_csv').onclick = ()=>{ 
    const csv = 'date,amount,note\n'+S.acc.map(r=>`${r.date},${r.amount},"${(r.note||'').replace(/"/g,'""')}"`).join('\n');
    blob('mbz_compta.csv', csv, 'text/csv');
  };
  $('#acc_pdf').onclick = ()=>{
    const w=window.open('','_blank'); w.document.write(`<!doctype html><meta charset="utf-8"><title>Comptabilité</title>${$('#acc_table').outerHTML}`); w.document.close();
  };

  // Toujours forcer la modale fermée au chargement
  closeSig();
})();
</script>
</body>
</html>

